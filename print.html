<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Smart Vaults Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="Description">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Release Notes</li><li class="chapter-item expanded "><a href="release-notes/0.4.0.html"><strong aria-hidden="true">1.</strong> 0.4.0</a></li><li class="chapter-item expanded affix "><li class="part-title">Miniscript Templates</li><li class="chapter-item expanded "><a href="miniscript-templates/decaying-multisig.html"><strong aria-hidden="true">2.</strong> Decaying Multisig</a></li><li class="chapter-item expanded "><a href="miniscript-templates/m-of-n.html"><strong aria-hidden="true">3.</strong> Collaborative Custody</a></li><li class="chapter-item expanded "><a href="miniscript-templates/hold.html"><strong aria-hidden="true">4.</strong> Hodl Lock</a></li><li class="chapter-item expanded "><a href="miniscript-templates/social-recovery.html"><strong aria-hidden="true">5.</strong> Social Recovery / Inheritance</a></li><li class="chapter-item expanded affix "><li class="part-title">Nostr Specs</li><li class="chapter-item expanded "><a href="kinds/index.html"><strong aria-hidden="true">6.</strong> Event Kinds</a></li><li class="chapter-item expanded affix "><li class="part-title">SDKs</li><li class="chapter-item expanded "><a href="rust-sdk/01-getting-started.html"><strong aria-hidden="true">7.</strong> Rust SDK</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rust-sdk/02-installation.html"><strong aria-hidden="true">7.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="rust-sdk/03-features.html"><strong aria-hidden="true">7.2.</strong> Features</a></li><li class="chapter-item expanded "><a href="rust-sdk/04-constructors.html"><strong aria-hidden="true">7.3.</strong> Constructors</a></li><li class="chapter-item expanded "><a href="rust-sdk/05-configs-and-relays.html"><strong aria-hidden="true">7.4.</strong> Configs & Relays</a></li><li class="chapter-item expanded "><a href="rust-sdk/06-profile-and-contacts.html"><strong aria-hidden="true">7.5.</strong> Profile & Contacts</a></li><li class="chapter-item expanded "><a href="rust-sdk/07-signers.html"><strong aria-hidden="true">7.6.</strong> Signers</a></li><li class="chapter-item expanded "><a href="rust-sdk/08-policies/01-index.html"><strong aria-hidden="true">7.7.</strong> Policies</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rust-sdk/08-policies/02-templates.html"><strong aria-hidden="true">7.7.1.</strong> Templates</a></li><li class="chapter-item expanded "><a href="rust-sdk/08-policies/03-custom-policies.html"><strong aria-hidden="true">7.7.2.</strong> Custom policies</a></li><li class="chapter-item expanded "><a href="rust-sdk/08-policies/04-funding.html"><strong aria-hidden="true">7.7.3.</strong> Funding</a></li></ol></li><li class="chapter-item expanded "><a href="rust-sdk/09-proposals.html"><strong aria-hidden="true">7.8.</strong> Proposals</a></li><li class="chapter-item expanded "><a href="rust-sdk/10-connect.html"><strong aria-hidden="true">7.9.</strong> Connect</a></li><li class="chapter-item expanded "><a href="rust-sdk/keychain/01-index.html"><strong aria-hidden="true">7.10.</strong> Keychain</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rust-sdk/keychain/02-change-password.html"><strong aria-hidden="true">7.10.1.</strong> Change password</a></li><li class="chapter-item expanded "><a href="rust-sdk/keychain/03-secrets.html"><strong aria-hidden="true">7.10.2.</strong> Secrets</a></li><li class="chapter-item expanded "><a href="rust-sdk/keychain/04-wipe.html"><strong aria-hidden="true">7.10.3.</strong> Wipe</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="js-sdk/01-getting-started.html"><strong aria-hidden="true">8.</strong> JavaScript SDK</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="js-sdk/02-contacts-and-profiles.html"><strong aria-hidden="true">8.1.</strong> contacts and profiles</a></li><li class="chapter-item expanded "><a href="js-sdk/03-signers.html"><strong aria-hidden="true">8.2.</strong> signers</a></li><li class="chapter-item expanded "><a href="js-sdk/04-vaults/01-vaults.html"><strong aria-hidden="true">8.3.</strong> vaults</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="js-sdk/04-vaults/02-creating-a-vault.html"><strong aria-hidden="true">8.3.1.</strong> creating vaults</a></li></ol></li><li class="chapter-item expanded "><a href="js-sdk/05-proposals/01-creating-proposals.html"><strong aria-hidden="true">8.4.</strong> proposals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="js-sdk/05-proposals/01-creating-proposals.html"><strong aria-hidden="true">8.4.1.</strong> creating proposals</a></li><li class="chapter-item expanded "><a href="js-sdk/05-proposals/02-fetching-proposals.html"><strong aria-hidden="true">8.4.2.</strong> fetching proposals</a></li><li class="chapter-item expanded "><a href="js-sdk/05-proposals/03-approvals.html"><strong aria-hidden="true">8.4.3.</strong> approving proposals</a></li><li class="chapter-item expanded "><a href="js-sdk/05-proposals/04-finalizing-a-proposal.html"><strong aria-hidden="true">8.4.4.</strong> finalizing proposals</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Articles</li><li class="chapter-item expanded "><a href="articles/intro-to-ms-es.html"><strong aria-hidden="true">9.</strong> Introducción a Miniscript</a></li><li class="chapter-item expanded "><a href="articles/intro-to-ms-en.html"><strong aria-hidden="true">10.</strong> Introduction to Miniscript</a></li><li class="chapter-item expanded affix "><li class="part-title">About</li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Smart Vaults Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/smartvaults/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div align="center">
  <img src="SV-Logo-Vertical-Black.svg" width=400/>
</div>
<p>Smart Vaults is an interoperable smart wallet ecosystem for Bitcoin. It defines a specification (with implementations in Javascript and Rust) for managing partially signed bitcoin transactions (PSBTs) and miniscript spending policies over Nostr relays.</p>
<p>Smart Vaults is intentionally designed to work with limited backend infrastructure; the only requirements are a Bitcoin node and a Nostr relay. This makes it easy for sovereignty seekers to self-host their own and simplifies integration for developers.</p>
<p>One of the first steps to using Smart Vaults is creating a new signer key. This must be done on the mobile app or desktop GUI. The extended public key (xpub) of this signer is shared with Nostr contacts that you wish to collaborate with. Signers are encrypted and only shared with contacts you approve individually.</p>
<p>Signers are shared via the Nostr public key (npub), which can be done app-to-app via QR code or via copy/paste out of band. There is also an invite process that prompts a user to download the app, create a signer, and then share it with the inviter.</p>
<p>Now that signers have been share among a group, they can begin creating vaults using the signers.</p>
<p>Currently, the mobile app and desktop apps are the only supported signers. Our initial focus is optimizing for easy and fast hot wallet approvals for vaults. However, users can have multiple signers and we will support hardware wallets in the future.</p>
<p>When a new vault is created, an encryption group is created for the vault participants to share information that only they can view. This includes the vault configuration (spending policy), name, description, spending proposals, and utxo labels.</p>
<h2 id="proof-of-reserve"><a class="header" href="#proof-of-reserve">Proof of Reserve</a></h2>
<p>Smart Vaults supports proof-of-reserve attestations on vaults. These proofs can be generated to cryptographically prove that the members of the vault have key access and ownership over the vault’s set of UTXOs.</p>
<p>Regular proof-of-reserve attestations are an important component of custodial hygiene, especially in multi-party or multi-institutional custody vaults.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-04"><a class="header" href="#release-04">Release 0.4</a></h1>
<h2 id="key-agency"><a class="header" href="#key-agency">Key Agency</a></h2>
<ul>
<li>Key agents are trusted parties that hold custody of one or more keys on a multisig vault. See our <a href="https://smartvaults.io">Key Agency FAQ</a></li>
<li>Key agents can use Smart Vaults to register, configure, and share their signers (x-pubs) with users.</li>
<li>Key agents can specify their price in USD or sats, in price per signature and/or an annual flat rate or basis points.</li>
<li>Users discover key agents through the Key Agent catalog, and they collaboratively build vaults.</li>
<li>Key agent fees are auto-calculated and pro-rated, facilitating processing of micro-transactions to pay key agent fees during low chain-fee time periods.</li>
<li>Contact us via <a href="https://t.me/+I3B8_4tz7sMwZjVh">Telegram</a> to become a verified key agent or try it out on the <a href="https://smartvaults.dev">testnet</a>.</li>
</ul>
<h2 id="vault-collaboration"><a class="header" href="#vault-collaboration">Vault Collaboration</a></h2>
<ul>
<li>Added vault invite and join flows, including non-participant ‘watchers’</li>
<li>Ability to send encrypted chat messages among vault participants.</li>
<li>Group chat messaging attached to spending proposals.</li>
</ul>
<h2 id="usability-improvements"><a class="header" href="#usability-improvements">Usability Improvements</a></h2>
<ul>
<li>Mobile push notifications (blinded/end-to-end encrypted) when a user shares a key, participates in a vault, and when a proposal is made, approved, or broadcast.</li>
<li>UTXO Management: label receiving addresses and UTXOs, select UTXOs as inputs on transactions.</li>
<li>Policy path selection: select the tap tree script path when building a transaction (enables more flexible and dynamic miniscript policies)</li>
<li>Added ability to view vault balances in fiat (web)</li>
</ul>
<h2 id="hardware-wallet-support"><a class="header" href="#hardware-wallet-support">Hardware Wallet Support</a></h2>
<ul>
<li>Coldcard (EDGE firmware)</li>
</ul>
<h2 id="minitapscript-template-vaults-for"><a class="header" href="#minitapscript-template-vaults-for">MiniTapscript template vaults for:</a></h2>
<ul>
<li>Decaying Multisig</li>
<li>Collaborative Custody</li>
<li>Hold Lock</li>
<li>Social Recovery</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="decaying-multisig"><a class="header" href="#decaying-multisig">Decaying Multisig</a></h1>
<h2 id="description"><a class="header" href="#description">Description</a></h2>
<p>Decaying multisig is a custody technique where the number of keys required to move the funds decreases over time. For example, a 3 of 3 multisig may decay to only need 2 of the 3 keys after 1 year, and then to 1 of the 3 keys after 5 years.</p>
<p>One use case for this is mitigating against loss of funds due to key loss. If a key is lost, the owner only needs to wait until the next decay step to recover the funds. Another use case is for loosening consensus for co-managed assets. For example, a board of directors may generally require a higher threshold (67%) to spend funds, but decrease that over time (to 51%) to avoid allowing a subset of signers to deadlock the funds.</p>
<h2 id="vault-configuration-example"><a class="header" href="#vault-configuration-example">Vault Configuration Example</a></h2>
<p>All 3 signers are needed to spend. After 10,000 blocks, the <code>after</code> block meets one of the threshold's conditions, so only 2 signatures are needed to unlock the funds. Finally, after 20,000 blocks, 2 conditions are met by the <code>after</code> statements and only 1 additional signature is needed.
<img src="https://github.com/smartvaults/smartvaults/assets/32852271/199630b1-8812-45ce-9d44-6f2a35e030e6" alt="image" /></p>
<h2 id="inputs"><a class="header" href="#inputs">Inputs</a></h2>
<ul>
<li>Threshold</li>
<li>List of Signers (extended descriptor)</li>
<li>List of Lock times (integers)</li>
</ul>
<h2 id="miniscript"><a class="header" href="#miniscript">Miniscript</a></h2>
<pre><code>thresh(
    &lt;threshold&gt;,
    pk(Key1),
    pk(Key2),
    pk(Key3),
    ...
    after(Timelock1),
    after(Timelock2),
    ...
)
</code></pre>
<h2 id="output-descriptor"><a class="header" href="#output-descriptor">Output Descriptor</a></h2>
<pre><code>tr(InternalKey,thresh(3,pk(Key1),s:pk(Key2),s:pk(Key3),snl:after(Timelock1),snl:after(Timelock2)))
</code></pre>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<p>Example Output Descriptor</p>
<pre><code>tr(3ec243044db203bc418092014b46bfe9494a1c16ee66160e385d7dd676e378cd,thresh(3,pk([7356e457/86'/1'/784923']tpubDCvLwbJPseNux9EtPbrbA2tgDayzptK4HNkky14Cw6msjHuqyZCE88miedZD86TZUb29Rof3sgtREU4wtzofte7QDSWDiw8ZU6ZYHmAxY9d/0/*),s:pk([4eb5d5a1/86'/1'/784923']tpubDCLskGdzStPPo1auRQygJUfbmLMwujWr7fmekdUMD7gqSpwEcRso4CfiP5GkRqfXFYkfqTujyvuehb7inymMhBJFdbJqFyHsHVRuwLKCSe9/0/*),s:pk([f3ab64d8/86'/1'/784923']tpubDCh4uyVDVretfgTNkazUarV9ESTh7DJy8yvMSuWn5PQFbTDEsJwHGSBvTrNF92kw3x5ZLFXw91gN5LYtuSCbr1Vo6mzQmD49sF2vGpReZp2/0/*),snl:after(1721743844),snl:after(1747663844)))#p0skyz4j
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="collaborative-custody-template"><a class="header" href="#collaborative-custody-template">Collaborative Custody Template</a></h1>
<h2 id="description-1"><a class="header" href="#description-1">Description</a></h2>
<p>Collaborative custody allows users to configure the number of co-signers and the threshold required to access the vault’s bitcoin.</p>
<p>Users can choose a 2 of 3, 3 of 5, or a custom configuration, this feature ensures that multiple trusted parties agree before a transaction takes place. It's an ideal solution for shared ownership and collaborative arrangements.</p>
<h2 id="vault-configuration-example-1"><a class="header" href="#vault-configuration-example-1">Vault Configuration Example</a></h2>
<p>To authorize a transaction, any combination of 2 out of the 3 keys (Thomas, Lee, or My Signer) is required. In other words, you can use any pair of these keys to successfully spend the funds.
<img src="https://github.com/smartvaults/smartvaults/assets/88842056/87b42cbc-4c7c-48c6-b924-82eae77651a4" alt="image" /></p>
<h2 id="inputs-1"><a class="header" href="#inputs-1">Inputs</a></h2>
<ul>
<li>Threshold</li>
<li>List of Signers (extended descriptor)</li>
</ul>
<h2 id="miniscript-1"><a class="header" href="#miniscript-1">Miniscript</a></h2>
<pre><code>thresh(
    &lt;threshold&gt;,
    pk(key_1),
    pk(key_2),
    pk(key_3),
    ...
)
</code></pre>
<h2 id="output-descriptor-1"><a class="header" href="#output-descriptor-1">Output Descriptor</a></h2>
<pre><code>tr(InternalKey,thresh(3,pk(K1),s:pk(K2),s:pk(K3)))
</code></pre>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<p>Example Output Descriptor</p>
<pre><code>tr(885db1e89516e0f0adc15ff8389320a01270a54f3b8ea4ecc705472904fc9a7e,multi_a(2,[7356e457/86'/1'/784923']tpubDCvLwbJPseNux9EtPbrbA2tgDayzptK4HNkky14Cw6msjHuqyZCE88miedZD86TZUb29Rof3sgtREU4wtzofte7QDSWDiw8ZU6ZYHmAxY9d/0/*,[4eb5d5a1/86'/1'/784923']tpubDCLskGdzStPPo1auRQygJUfbmLMwujWr7fmekdUMD7gqSpwEcRso4CfiP5GkRqfXFYkfqTujyvuehb7inymMhBJFdbJqFyHsHVRuwLKCSe9/0/*))#g52crz77
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hold-template"><a class="header" href="#hold-template">Hold Template</a></h1>
<h2 id="description-2"><a class="header" href="#description-2">Description</a></h2>
<p>Hodl time locks let’s user set specific time intervals, with a maximum of 24 months, during which their bitcoin remains locked.</p>
<p>The hodl time lock feature prevents impulsive selling during market fluctuations and allows users to stick to their investment strategy.</p>
<h2 id="vault-configuration-example-2"><a class="header" href="#vault-configuration-example-2">Vault Configuration Example</a></h2>
<p>To spend the funds, the second condition must be met, which involves an absolute timelock represented by <code>1701559661</code> in the example.</p>
<p>This timelock will be satisfied after the specified time [1 month] has passed since the creation of this transaction.</p>
<p><img src="https://github.com/smartvaults/smartvaults/assets/88842056/5626c0ff-9351-427a-8bcf-86f33f441eb8" alt="image" /></p>
<h2 id="inputs-2"><a class="header" href="#inputs-2">Inputs</a></h2>
<ul>
<li>Signer key (extended descriptor)</li>
<li>Timestamp or Block Height if using an absolute timelock (<code>after</code>), number of confirmed blocks if using relative timelock (<code>older</code>)</li>
</ul>
<h2 id="miniscript-2"><a class="header" href="#miniscript-2">Miniscript</a></h2>
<pre><code>and(pk(Key1),after(TimestampOrBlockHeight))
</code></pre>
<h2 id="output-descriptor-2"><a class="header" href="#output-descriptor-2">Output Descriptor</a></h2>
<pre><code>tr(InternalKey,and_v(v:pk(Key1),after(TimestampOrBlockHeight)))
</code></pre>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<p>Example Output Descriptor</p>
<pre><code>tr(e3e5c4a66d85841b9cea26793ef640bf7c1d26e759ae0296e643a16dad606c02,and_v(v:pk([7356e457/86'/1'/784923']tpubDCvLwbJPseNux9EtPbrbA2tgDayzptK4HNkky14Cw6msjHuqyZCE88miedZD86TZUb29Rof3sgtREU4wtzofte7QDSWDiw8ZU6ZYHmAxY9d/0/*),older(10000)))#e4gyn573
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="social-recovery-template--inheritance"><a class="header" href="#social-recovery-template--inheritance">Social Recovery Template / Inheritance</a></h1>
<h2 id="description-3"><a class="header" href="#description-3">Description</a></h2>
<p>Social recovery keeps you in full and exclusive control of your bitcoin while enabling a recovery path in case you lose your keys. After a predefined number of months set by the user, an m of n multisig of trusted co-signers is able to move the user funds</p>
<p>Between 20%-25% of all bitcoin has been lost forever by owners who lost their keys. This security feature helps you have a plan B, leveraging trusted connections like friends, family, or colleagues to regain access to your Bitcoin</p>
<h2 id="vault-configuration-example-3"><a class="header" href="#vault-configuration-example-3">Vault Configuration Example</a></h2>
<p>To initiate the spending of funds via social recovery in the multisig setup, it can be accomplished either by your designated signer or by following the social recovery path. However, this is only possible once the specified timelock duration has elapsed, and it requires the authorization of at least one out of your two designated signers for recovery. [either Thomas or Lee]</p>
<p><img src="https://github.com/smartvaults/smartvaults/assets/88842056/82d15056-8679-4ba0-8bfe-2095ffccb6c9" alt="image" /></p>
<h2 id="inputs-3"><a class="header" href="#inputs-3">Inputs</a></h2>
<ul>
<li>Signer keys (extended descriptor): 1 + N for recovery</li>
<li>Timestamp or block height if using an absolute timelock (<code>after</code>), number of confirmed blocks if using relative timelock (<code>older</code>)</li>
</ul>
<h2 id="miniscript-3"><a class="header" href="#miniscript-3">Miniscript</a></h2>
<pre><code>or(1@pk(Key1),1@and(thresh(2,pk(RecoveryKey1),pk(RecoveryKey2)),after(TimestampOrBlockHeight)))
</code></pre>
<h2 id="output-descriptor-3"><a class="header" href="#output-descriptor-3">Output Descriptor</a></h2>
<pre><code>tr(Key1,and_v(v:multi_a(2,RecoveryKey1,RecoveryKey2),after(TimestampOrBlockHeight)))
</code></pre>
<h3 id="example-3"><a class="header" href="#example-3">Example</a></h3>
<p>Example Output Descriptor</p>
<pre><code>tr([7356e457/86'/1'/784923']tpubDCvLwbJPseNux9EtPbrbA2tgDayzptK4HNkky14Cw6msjHuqyZCE88miedZD86TZUb29Rof3sgtREU4wtzofte7QDSWDiw8ZU6ZYHmAxY9d/0/*,and_v(v:multi_a(2,[4eb5d5a1/86'/1'/784923']tpubDCLskGdzStPPo1auRQygJUfbmLMwujWr7fmekdUMD7gqSpwEcRso4CfiP5GkRqfXFYkfqTujyvuehb7inymMhBJFdbJqFyHsHVRuwLKCSe9/0/*,[f3ab64d8/86'/1'/784923']tpubDCh4uyVDVretfgTNkazUarV9ESTh7DJy8yvMSuWn5PQFbTDEsJwHGSBvTrNF92kw3x5ZLFXw91gN5LYtuSCbr1Vo6mzQmD49sF2vGpReZp2/0/*),after(840000)))
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kinds"><a class="header" href="#kinds">Kinds</a></h1>
<p>In the current protocol (<code>v1</code>) all objects (<code>shared keys</code>, <code>vaults</code>, <code>proposals</code>, ...) are encrypted using <a href="https://github.com/nostr-protocol/nips/blob/master/04.md">NIP04</a>.</p>
<h2 id="9288---shared-key"><a class="header" href="#9288---shared-key">9288 - Shared Key</a></h2>
<p>This kind it's used to share shared keys between participants of a <code>vault</code>.
It's used to encrypt and decrypt everything related to a <code>vault</code>.</p>
<h3 id="required-tags"><a class="header" href="#required-tags">Required tags</a></h3>
<ul>
<li><code>e</code>: event ID of the <code>vault</code></li>
<li><code>p</code>: public key of the user able to decrypt the content of this event</li>
</ul>
<h3 id="example-4"><a class="header" href="#example-4">Example</a></h3>
<pre><code class="language-json">{
    "content":"PDj1bNB1PuWKzPc1RrKBmbEeXDaYkxRIsAqTraJscUq4ML3+mZzJq4O6vPkkIJeZuNQTp0EyLxAvUblXCgJxaEgwxRWQC+rpdz3ILjdQA2w=?iv=B5KnzXU7smmAWevhTi1rSg==",
    "created_at":1693903672,
    "id":"6bc1eb162aa5d0623370d808578d15a77e1e91a55ee93255ec070d5e03b4c87f",
    "kind":9288,
    "pubkey":"f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046",
    "sig":"ad9bc22082b5b5d23b75bb3752109b1d6d97a7ff29f1effdc710943c69f7550479856c06e76e4361e033be7400a27a9e688b3a4cf417840b7dd2b0df1403ec39",
    "tags":[
        ["e","071dd01141b000f7d0c9f8172101e8efb5771939456d8e4a3f8b37f6d458e82d"], // Policy ID
        ["p","f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046"]
    ]
}
</code></pre>
<h2 id="9289---vault"><a class="header" href="#9289---vault">9289 - Vault</a></h2>
<h3 id="required-tags-1"><a class="header" href="#required-tags-1">Required tags</a></h3>
<ul>
<li><code>p</code>: public keys of the users involved in the <code>vault</code></li>
</ul>
<h3 id="example-5"><a class="header" href="#example-5">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "description":"Vault description",
    "descriptor":"tr(...)",
    "name":"Vault name"
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"uTK3M5F958K1HKEJf/8ciVNLVw0u6dwkSANxWGBkZvpM3/3kIR/miLUPGuYLskl8ttBcLRXU07fq1mhC0+PsppJo5PQ3XyWFGWGWOQXktOKPIhpQcbpX6xCZACKN9BP6x1kCt8RCJB8nwqx0mD21syZRoQdOqKXWR/1r4rqknMS4uPY3nwT15vkP0p6zP6ZD4m9ykBhiRhGiUYxdakMcKcfHt1R22OF0trCt1+KpL9cdVqHpiiJy9hofgKb7wqPFnwcoRVlariXoQIIOoZHzOS69rzmqLFAyz6PWl2ifSwhDX9VCMw6vzp8Trp0lO/txhGW6+mIn9DBebj0cJQCygUaUmpzyBXOAzuzndUDPHMsls12qeOfX64edLgGyC/jL7qG9HS6Z1Wo91jlpqwTmqY3yzMGGcMZ01VkJ0jmbB8OuuO/BfrU3YMLQMAXMyc8BVyyksNIrG9tEMJlGDe4w1Wl2Ss7jiZRqLzuJua7w0RpApAmQ8zAsaDojVOEES87/pG+Pl6EyQxnofMMmdi1A+LSBQBAjtglGdKaK740I6Cjc2acBwqohiM8CV+tbTCqn?iv=fPuKqXaCoczpZ/3eikrTbQ==",
    "created_at":1686479425,
    "id":"9e0dfd2177ea9357f0c165ed134a86a3c07449676d8315e12d159932ff428e37",
    "kind":9289,
    "pubkey":"4639e297633117888df17deed6b3860ff152e9e464690623b6b3d6ae4923ad62",
    "sig":"2ff3f48a7e80db25418df983c732edbc495b0fb28f4fdf051955867c0e180131f7f7e9499957adee76bc9fdedc5fb7c8a71ec7e1655322e39cf5d4f590bfcd15",
    "tags":[
        ["p","3eea9e831fefdaa8df35187a204d82edb589a36b170955ac5ca6b88340befaa0"],
        ["p","f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046"]
    ]
}
</code></pre>
<h2 id="9090---proposal"><a class="header" href="#9090---proposal">9090 - Proposal</a></h2>
<h3 id="required-tags-2"><a class="header" href="#required-tags-2">Required tags</a></h3>
<ul>
<li><code>e</code>: event ID of the <code>vault</code></li>
<li><code>p</code>: public keys of the users involved in the <code>vault</code></li>
</ul>
<h3 id="example-6"><a class="header" href="#example-6">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "Spending": {
        "amount":1928,
        "description":"Proposal description",
        "descriptor":"policy-descriptor",
        "psbt":"base64-psbt",
        "to_address":"mohjSavDdQYHRYXcS3uS6ttaHP8amyvX78"
    }
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"ShT2G9QmydYwcYEfqdXQvLYKSP4Gi4AfxL0XrtuO9C6y64wp+nHYQQ0IOZdA7YTtkfQ8n5c8/ZLJkjl3oJosVGbmrT/7H98Q+wM3IwFBKlOTdzq8g6Cdjx6lMfmm+wfysLu3X+ZN6xO6vK+cXCZpNeShChnC52uaVfd4afNG9qUsdGGPueQoX/TpmjHLRd/v4HfOf+aAGJalNNpHxugK4XR/Tb5zCMrLkMT/JOdz4jIFV71FZunyCvT/Iafz4aN1hUhFJjG/ERueSsOdRJpdkI/15M4rOMBgWm4/kW6MKGgTRFO5yLin0C4oqHmDb3urPTDirTk2ENDgZ0nhj6GcpjDNg92508fUkdjTcu6Td4stK3VLsSAhyf/KECXC87mvn5F8r0SkJGUHDbgtG7yFd8RMg5gJ77+wP4NdpFIuJ8Yiziz3KWY6Q1dSMpsPrgvLtCuRsyaR6rxISt47ELrUY/U0vruz26LCAILF0G7MyAEkeK6bgHZPWow07jCBJ7V9bBPrCCDsGpzekLO/cqrsSV8qGK1hvwCZ51CCf6OFdWoRagsTO/uqxts+CddGhFbQZQB3LiSU4Pd/Vm1RoajAm7YEWU+DT+eGPMvavWGIAFrYzrXZi8LL49YI2K4+0hvhgoQKUI7YiFM7ZhfohA0Utrv+JDjD7jIQjgVM7HpZoP5p4OOOd/YeMl3XqsaVnSUZDfj8Vs8bXgu7TnhibkUEhR8NqxuA5f8EmWjlwMuxwQP7HoIfhSIpyki6JnPPt7vKhVn8hBOFbhbbrRO2cw2jFezHmcbGcQV4R+QCmaRK43iWgbG3Yu3uZ8qZnjeLfl/BJHf61gruzC8CYphTSBUIjlA16IjcH24B9TO02b76EIBDsNoOAB3KKeb7t0glIAS4XG1fXX4WgJdEwp8ehCttUyo55FYDT8+jeO2REYxc401JtsPAF9e6Y9Xk/xYkOvjziFXz+n/9ygH4j5LW0PPsWMybSttYsm1X+O2icHiWrNnKufCACMJMStGC2TnUQkVWZMQE8n+UEsrWopKEzkKwsF0CmbhQ2nPfN7xZm1Z2mKNMvG/J53Ig3x5TlOKRTcd7aksX2F+d24pkr78DdaExnUixY7DR3YVBqitiXcRr+nJdtu5OqkVpqejk3jU6EDBbL2PE+A3/qAfuMGZ+DhAQaHw+lDBveFY0DpmcI1N7+84vaj4vCtXonVnZ5Tz1xHyn3I+J+Ud7UWctRUD86JLeCVlZEzqOQwrhZ+G9JctnPVlBs2D2JSwjtAkg4kXcgHOq7+d5zGdPk3uW4xABj4nuDZ3SqxhwaGbz2+8uzKMBoq6vNx8bIl/oDKSZl43rXfr91BdeAgneXUfTaqlAwdNpXqVHAduZTQpkeX7jS84IrzJ7yT2wIehC6tEXqZVEhpZzO3AhU7dacEv4JdN/k3rRNbXAwQhoeTs+25DXjXkhnvV5OD6LNMDm6EtH+eeGZPvx6YlvADi2XAXh/1QQJVkNof+miH5wmIAtwI1PnKFu49mXAvDSsC6a8xgKZCdeu+VuhoDL4WGxo+DoPTAYL4cuk004MXmIrxjTLF22gzPPmuUCCpYbJZplXY3Ax/f6LY69RfVPeyxZIPOOGQWPHPDW8lYgoXlBMHaYdMkUqiSAJ2rml46HjTLz38l+eMq5yNCNlZnHuk/s7eaRpTVdKQ6IW6gPgCeNNGxvoEAhL4ZtdM3PRKXbZYvM9CEZ7IUT8Izg84kCayvh3AqFfR/2htl8EK4jpP3JEwak8I2j87vTH8bmjXqJxJV0gClwdn01bqWmZ1Z6xIkBTFrThyrOPrrmKqlllN1uoCOODufUv6DaEbg7iy7v7iTSq5k7MGAyPRYJt4qlX3yuI3s1p/7XuO45YqPiweZNnDDDghesWncYuTEK2wOND0QUpI2lgtSKHYPx0akNjjRE8hcQ89iAWZl+XQwNsEIKJkT3ZlJpMUG2VjYRRkmHRmN/Wkq+7geYz4bm07P2lCu8Pcge5qR3SLcorE7ykmzvFGo3JnE3vmFzcMtxBFq0hReY2wlsyECCzLQogCSVc7xw4jjNZCoFIw1G4gGxg18ed6uP1jUdqvVtF7pON18SusTjXJ7ggZaFmfQwFb7PcrpnWfJnrDexA22rBsja3RmJLJcms43Aozs6sksrYlU7ObCebP3KBFV5gGFbXR4T+rDmNlFDf6lC3rgD2OvMIGvT4f2fS3QaG2ZUCMFObNv2wwK8nKouoTQ+zEWKVyVflapsTKQ7vPMC4yO+C76aafbrzYvbtYWYCsL4uHnuNgUDg+rHHNqe51fIUhQOwdgWJ7+kmjHJO0U1UiD/xKjfqnixR1S8mx7zoMD+521hk+SVR33f3+K5CtFGITSBjJnLTugb1IL8wSkImwivj8gdgj5XZ9Gc4WKpiB/rNOQjPPmVTae+EKT1Sii5/kA5cXyPXq30igkFFwhyovzmqXt7l9szBW4U8Sj64lgfen7DCN2JBU1XCSXMeP9g5B/sv/lLKEOnFQLDJGH76U9M01hi/8ZFflgsxRE2ZgBECz3ehnCePKxNup692sR3Bog6w0Pz+4QjJRrEYrZmXoLLEX5dk9qc36NxxJm1Jo+BWvUerVcS0S8jkyh1kep5MVhBF3ey1nxwoBxnz5EtWsZhnf3An6D/ZvfaydXwFvJ1a77Hnh+YwtDC6r9yIyrmqHfvikg8fO1Rq/KLR0oI/vjEg5aldJVO2+gRBHsdgzXaX/2p9bz8ZIPDs4/8C2ShuwJc5HDj8hiro5yscpuQNnPSo1apWUdGt/P0u2AnhPXjid57gLYynDs50k7fzxXJvBDU2b4CS91NMuXWg6nIXI4XwQ+x94ZNOQGXInf1aFO4Vt6vA+8Bb6I716vkQKHFZIacqJpuddRQfqQafeXfzeUWtcReolxdsDr58rVlAiWqjILwAZJlaGpZneg9S9hz7Nl/pq1a7FcFGOhUm4/fHHm/efHENmi+JlHj9D8desRwenOda1BkjMjumSovLjltNrq+177z4iiROXqW//ViefV9eXHX0s7YQM3NOOldErYCP6gs1VQrvZPth9vwbjtuLBKEvMGqvSzrNxdTSuWopr9gPpz00mtaR508entx6l0DdK/WpduztyFvZLRm0d92egk7L0Mr2phmIB4kmDyh9VibdA5bGzKRCQJsIWaCTVs17Qw=?iv=whier1QoEXYwFJhwcpcl3A==",
    "created_at":1694781913,
    "id":"726e919e26dcc70dbc3926660afa589793233ca6c94e69f9687fd03c02f74263",
    "kind":9290,
    "pubkey":"4639e297633117888df17deed6b3860ff152e9e464690623b6b3d6ae4923ad62",
    "sig":"5c88ff5bf65fe8da798bfd8303f493040055748d6c06d623b26393d78631edc0dadd79a4cd6f10930feb43d23900390c7dabbf5287c4a32b8c0970a6a3e9d0c1",
    "tags":[
        ["p","3eea9e831fefdaa8df35187a204d82edb589a36b170955ac5ca6b88340befaa0"],
        ["p","f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046"],
        ["e","9e0dfd2177ea9357f0c165ed134a86a3c07449676d8315e12d159932ff428e37"] // Policy ID
    ]
}
</code></pre>
<h2 id="9091---approval"><a class="header" href="#9091---approval">9091 - Approval</a></h2>
<h3 id="required-tags-3"><a class="header" href="#required-tags-3">Required tags</a></h3>
<ul>
<li><code>e</code>: event ID of the <code>vault</code> and the <code>proposal</code></li>
<li><code>p</code>: public keys of the users involved in the <code>vault</code></li>
</ul>
<h3 id="optional-tags"><a class="header" href="#optional-tags">Optional tags</a></h3>
<ul>
<li><code>expiration</code>: UNIX timestamp of the expiration of the approval</li>
</ul>
<h3 id="example-7"><a class="header" href="#example-7">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "Spending":{
        "psbt":"base64-psbt"
    }
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"xTv+0Vw4fzB3Kt5x6LK9rjnbIG7sL7J1J+nvoA1OmBw4ERa/8xvqQKv4DWkjDpy58cHYrtidnIcYeNsG0ATQ1p5VSlpqb4bw4RS2OpMT7MbTqS5jSTqpOTSSeu2zDc2yF0+VE3GgDydrt5ck5Hx8rdkPkAJ+rLJ4tcAUBo53gMzTBJ/wGMFTTsVK9w6nSq43ERfow3fzoxwUIru9gBbOFoYg+svqPByL/GvIuvjTPPHGzimQxdTqkkmAy+pjSTYE/UJ4rVbmuerdoQAH87cYwWmpcPaF0hbsvV2071DhMJjHFASN0L/1zjRYZheddDZNT9ePyv6tHQ4RczJF4apR8lyUEJp6wECU6/xFy5dXMn0a6VDrPFJ8s9A3dSD+6CkCI1o3wIBlixPDQUDtNN69h1ZMJhDbiirFXsAYy9nkA5LGDYhUw9mdB8NG5friFxthZW1cwWYm/uudUAreOJBtUaNqNLhwfxvgnDjDjUrgOnT+DxRllsnLoshuv0IXwcYp5dYtiD/e30lEefdeZ4CrIfQdZkndpIBfcwBJG0RUNgfOdkVgurhhxuKFp3/oHaW8X+EnIW6EQRR0ut4PQJFglQtjGJjUlZ5yb/IBGvGnVfgGXLThN0hiA5QP78CBWinkEbPL/Z0mOI6bLkVW4Zo+xt4Pntxh2k4PSO5SizuZz7EWkmTt9Jxq+597T7Io6t6m6Kx7ryURN1OPwSGEXdxyRkIOcwxOsD2RILvwxF5h/Mt/Z/oyJ0ylUTTyxkkAbzluhtjlLyC1lzmE6L0U4P9/iK/7TMequnT24Rtt44HggpYP7d9a9dasvCDiZLUvxLGnjKN7RAoxQb1j9zELOl0LKem84/e5vIIeobYaH000FYiup1imxPZJ+Ufd/K6Coxf7YQY7TCqP79xLGteM2saium8WP3IH9yd4R/g7fxFVTt37S/Ys67HHNgmDx6fzb5NOgwTs/Iz8IO4LMiXVZAoJJ5cC+6lwbgNuuSvQ50g67NdY+NLWyVofFY3TJkkx/bXeracUlJrxKJG4jYQhm41z4/UKCFnAf5uq+6aDoWUpyNu2QB4Z+6glYH5IyJz2XgbZBz1zjWb4BCc/tT17J9UCn/B1OIKLFnHl+2tLR0T8/ZN6cwRlA/o3S9vTmNbu5QtvEqXxlE+r9OasCwPXrmV2QdYw8I/h1XzbDFPK54UGJVxy1P3CM0oGtnCibaZdFyslAr/R+l79NHw64ApuEhP7ZNHTFxB2yLfMAcAYf6fuqw0YxJiV78ui1fSue4IUV6+wlPFKBfz/RqTG0zkmZId8NPiPXUCzy7wMvZwcTZFEhZOUijlxLBWMwr3tXYzJHUbWfzHrhwued68SWw0AinUeP3mkREju0uo7ja6pKKFtAhP+VzO9ZqqTA+VDAIlNmvFw4aela8MLbgNCpVDNI3wxj3fb0PpWjmETG1DrDPpkYlpBBBRemFOOhhwcLx4kjNqKr4db1cYN/A5wWe6QXOTPs9EeyrWQXGOIxNgQA0+VJJeynmXGxZ2Vsb+mhj/X7XHyVKOl4yAvx9xqe+kMsDg7Ww9bT2jiIJ0kqOjxZmusa3v/naV7rGjKRbkBE7U4xdsgfb+Z7wIBo0qkSQyMYqDt2L26Nj77pQkCjvitpm0WULl5hTJMCnTxtE8io/C3TsVQ1PaKWYNAJi9W/OcOmgPH1gq+EKmgrgi1sfUk2KXEVALQWncbSZtBAqMLtsH3R0+I//03VbeMFFvWXi7yDfVBE5iCUPcVpPFYSsrTdCHu6f5QMTukIn2xplKsAK6tk7hMfZ+3u9yzlC3M1GCe7PSm+tLlYSOxkB1smmWn/ZLF1dYuoAyGbwGG+wL2J+GpjOO0u5LqZpO202CVhT9hZ178HjvDMYVqR7SIfnVR4mAIkvfvnoMYTJBEKjT9fKJNJCgi?iv=3uD9CK7zc9OTGN8VGyKqtw==",
    "created_at":1694703253,
    "id":"728e7aa746d4c207f118576d41908e92788616b86ae9108d3249fced0023168b",
    "kind":9291,
    "pubkey":"f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046",
    "sig":"7d6219e097559ad0b3ac8a5e7529a4f709cf0701d2003cc8ecacb829a3db723c819a0254b012faaddfd67ce690a7437c8cec01c90f94cf76472919e8a31a85ba",
    "tags":[
        ["p","3eea9e831fefdaa8df35187a204d82edb589a36b170955ac5ca6b88340befaa0"],
        ["p","f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046"],
        ["e","e64282e3491ebf5de5ca499bd211d5a26d1636d3197f7341d6eef804ed0a61b0"], // Proposal ID
        ["e","9e0dfd2177ea9357f0c165ed134a86a3c07449676d8315e12d159932ff428e37"], // Policy ID
        ["expiration","1695308053"]
    ]
}
</code></pre>
<h2 id="9092---completed-proposal"><a class="header" href="#9092---completed-proposal">9092 - Completed proposal</a></h2>
<h3 id="required-tags-4"><a class="header" href="#required-tags-4">Required tags</a></h3>
<ul>
<li><code>e</code>: event ID of the <code>vault</code> and the <code>proposal</code></li>
<li><code>p</code>: public keys of the users involved in the <code>vault</code></li>
</ul>
<h3 id="example-8"><a class="header" href="#example-8">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "Spending":{
        "description":"Proposal description",
        "tx":{
            "input":[
                {
                    "previous_output":"57bd3e5dce42855346698ed6afc5acb65746abfda56e93db11ffa8be3677f612:1",
                    "script_sig":"",
                    "sequence":4294967293,
                    "witness":[
                        "6cb594a167ba0266f8e7a0d774089da0d6b0213f9838667edf3c65bfa232c2c0b2c11f71902d17343faea56ac1f48299b35095f6d8967b6881d0741029e18216",
                        "e0b5eacc5044729bfbc79bbc3ca79f3f9c355400334d4a9b5890353d3f9027f8cc91233f677bf049e75d7ba3ae3499186c61f5b7521460f28119e078222d63a1",
                        "209125b5661a3388ab58218ef1f7fa6530fcc1fc450fd2bc2465f020037655bc5fac206cdbe7b03576c53da1deccd58f0605406d270df70bf925bafc9553672148e997ba529c",
                        "c00202020202020202020202020202020202020202020202020202020202020202"
                    ]
                }
            ],
            "lock_time":2502480,
            "output":[
                {
                    "script_pubkey":"76a91459cada50314c829e19f5a7786f8ee0d4987f429d88ac",
                    "value":1896
                },
                {
                    "script_pubkey":"5120045a52300c0628547fd851543dc9a0fc653b75bd7136d326a736a649251838f7",
                    "value":5594
                }
            ],
            "version":1
        }
    }
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"vMg2YFd3xXhNbLt+IK81FoBfvztBSLjEEiXzeTrYDrhOGmjhmNorLCl8JsRdjjMl1mULdX6UGmu1bQq3EY2v/HNLiiHfb/TU1LhD+XOXvRBUCQToEguarQcknVqVSry7GzIH+J0z6aT/DbYzMpWeA3g6q3HMBs6sj5QfBb6DokUKbFadq74CDnHoEgQ9qhcJaL3qZXL5g01J47u1ceHW+G6/iTEH+TFBKw4iQhdzFH+GyMugow3EmSvuPiiVFr+ZI6iAo14DqqjKKC41XW5wnFeZ2TZTbTHDqnTQrguvfULCpP7p7yOFKlnTUzd0Mgw41xB7FUFCkAmIpZaMNQErCIp0/PTtBZheUM9GHFvuJO3gmZ2B4b4HlbFEpNQ5S8+aYxIOaawLYKbdV7CNjE/hwB2ZQbDLB/UcQ8mbYzkEh6z2bARTCKoiqpNhIyj+OjZbkYjFm/J0ZDAOc8kSyuSqOXGyrtbL669ZBSRXxDkagBmX2lFJ3FZmDsWUbWDtY6IZsCIZDwncVH/P+hU1zUAh+vvdHtt4TSJ+4Iclg1sv9c/Rd/esgjlh4SMav/HBsjkGeaiifRP+rDq5JYRJZi+7xkna9vak1ClBBJL6NUpx87a3h3D95XcRBQQidJhCAMk0Smil5IOB7iz1H71SsJ88+mVNvw0S6Nxy2qfA3FU9j4Kz7X5+F74dHy4UHbn9GCCjNNCQXyZ8S1A/WtQQCv89Gnv99QcX6wkZtVpJ8dLsGUBzZ78xYkfjagzfj2idAxrlCTWmn7fdkc4ZWEzr6JE7GOnLyrjerfVZzecp5kuTM+7j170rLGgnOpt68MSTC7q68M3AwLW9/0s5iC5tMmZJuLnUvMg6A2ZSLr3IaDIazOgH3EbK3RsZ4AUwTRwiCYwu7LQTsiRMvAIG0wrfe3Ldb9G9qHyo5KgNr1CAb7upip0/HL04aNJISn5qEO/cCNM0nW2S41h+Xr9p6NDngnNPnLXC/r+Y1wSEt2bHuemlzC+BUZxsFG300bEpQMsiYJQFmj2JezmLkwLZSEhIPM7KsZ9HbjfowhAe1wF/hZ1iRDzCjknBu1LZcdQhe5Ptu6T2?iv=C4jXF0j5ldeCO6hv9Zajlg==",
    "created_at":1694705897,
    "id":"9a0cce3a14184cbd575ea8ef5f61caa1da830320ab8222902eeaf701bd20677a",
    "kind":9292,
    "pubkey":"4639e297633117888df17deed6b3860ff152e9e464690623b6b3d6ae4923ad62",
    "sig":"2fb7a6c956b66c3c189e2e9775483270ab95a82a7578d75390ce3e50a4d7b223cbce31402277c48d9f4565a02fbd933e676474eed81d69e32dce94d175406023",
    "tags":[
        ["p","3eea9e831fefdaa8df35187a204d82edb589a36b170955ac5ca6b88340befaa0"],
        ["p","f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046"],
        ["e","e534d73109b98a8a2f2627634ab1d0195923dd638b6aa76a63eb7eefa3d59e32"], // Proposal ID
        ["e","9e0dfd2177ea9357f0c165ed134a86a3c07449676d8315e12d159932ff428e37"] // Policy ID
    ]
}
</code></pre>
<h2 id="9094---signer"><a class="header" href="#9094---signer">9094 - Signer</a></h2>
<h3 id="example-9"><a class="header" href="#example-9">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "description":null,
    "descriptor":"descriptor",
    "fingerprint":"417a110f",
    "name":"Signer name",
    "t":"AirGap"
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"bVTA0YYf0+8CZXZtnBWMFu5YLyJR75YyRgAuiATQIvc2LEqiB9B5ARhypbtP+pGRXrhHGaPeZCzSunsP/sb5MXuXmsofAlzWeEAUcAaZC59z2hC97d2DSwYCQFE89MQTf9wrCPZGGAyfEMG9cnSeBuxldKKL5xOPCLfv4JqRSqdILI08h6leaxKTjZLJOLA+Pno7BZlsHazBuV7ZKwq6uGtsF3Nx2v3be+/210JnIrUFyOmCTqatkaLEHLHzekfTV86lJZTQ7YH7XE+TeQpen4H2ZlaJoeEB/JbR8PuONlVo1tjbWq8gdV0G/7kDs57LIzHW6pPsmyh1CNkokfp1Uw==?iv=UUAnvlWtfnHbj5bqDZomhA==",
    "created_at":1688205807,
    "id":"fe1b6712daabae7157b4948d74c53a01f6186c4ecf0619ea147de85fbed8735a",
    "kind":9294,
    "pubkey":"f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046",
    "sig":"65783a7e0e1cff481cfc861413a2485ce3e9c461887c51e6258d9e00023a8c34058239f55f2156e88c6052e3df252bdfbc5bd132ebe6773968621ece5517af41",
    "tags":[]
}
</code></pre>
<h2 id="9095---shared-signer"><a class="header" href="#9095---shared-signer">9095 - Shared signer</a></h2>
<h3 id="required-tags-5"><a class="header" href="#required-tags-5">Required tags</a></h3>
<ul>
<li><code>e</code>: event ID of the <code>signer</code></li>
<li><code>p</code>: public key of the user to you are sharing signer to</li>
</ul>
<h3 id="example-10"><a class="header" href="#example-10">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "descriptor":"tr(...)",
    "fingerprint":"00000000"
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"LC3wv4bucBHIIQkvR9iNlQbSHlEIRqRnfPM0cDwxYr8NRL57Jq1K6kmUbGPXrviDgYlUiNxxeRYNKqd2OX4vhjojUuUQpSr7B01zSS1nCi7JlJU1BdlNcvwZSN/Qd6cW+fXfBTLebdBVRDAR9N681i0rf1kaRI5v3kcTK/Kgq8YFDun0C85nRjyt1GsfcrH297w9nF1+uG3MXtTXAbh3sDPuEWLFR8MS8OEdjntlgD3VGIiwG+xzFdwwkNosptATp0GEjBQhG3jcccGgG9kUhg==?iv=TwMC14xa7Ux9BK6zyu1Cpw==",
    "created_at":1688207242,
    "id":"1220540b6c8f6d5179cafdae93e304a3cc4134a9d958f7c4094dc985347b5a8d",
    "kind":9295,
    "pubkey":"f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046",
    "sig":"e3df3184440dcbdb31f9dc13071e59375480f3f744b25586601d8f646edaf66e8f13699e46ae04683e6a6b26ffbf9a392f1cfee352d4cd13dba223650e63ba52",
    "tags":[
        ["e","fe1b6712daabae7157b4948d74c53a01f6186c4ecf0619ea147de85fbed8735a"], // Signer ID
        ["p","3eea9e831fefdaa8df35187a204d82edb589a36b170955ac5ca6b88340befaa0"]
    ]
}
</code></pre>
<h2 id="32121---label"><a class="header" href="#32121---label">32121 - Label</a></h2>
<h3 id="required-tags-6"><a class="header" href="#required-tags-6">Required tags</a></h3>
<ul>
<li><code>e</code>: event ID of the <code>vault</code></li>
<li><code>d</code>: unique ID of the <code>label</code></li>
<li><code>p</code>: public keys of the users involved in the <code>vault</code></li>
</ul>
<h3 id="example-11"><a class="header" href="#example-11">Example</a></h3>
<p>Unencrypted content:</p>
<pre><code class="language-json">{
    "data":{
        "address":"tb1p..."
    },
    "text":"Label"
}
</code></pre>
<p>Event:</p>
<pre><code class="language-json">{
    "content":"8pIsvOkUvh2necC9kQuRjDMRyDZPDzvigt/cy7RY+690KUwqT/IluT7+yezIO5i2EG9EyizVFGOn35unILaF3tiquGACLvFy39pSwdZCLdNWQcPWFFn/BPLBW/9j9RJy3UqBr9YHdPABDo4nsdd1Ww==?iv=hl9l3SiUiHss58o4oxi8Dg==",
    "created_at":1694864773,
    "id":"1fd6cbd917c1e2ed2b0b3d18755460e49fbdb1ae46301e68c77747bbbf542244",
    "kind":32121,
    "pubkey":"4639e297633117888df17deed6b3860ff152e9e464690623b6b3d6ae4923ad62",
    "sig":"d88ef25b04104a46d2568084fe268a10518fcb8c1c85999d462389f067ac79ccaec285b84cb2600fedfae04650fd12cdbe070f4b167ca7acd0bc86f4ecb83daa",
    "tags":[
        ["p","3eea9e831fefdaa8df35187a204d82edb589a36b170955ac5ca6b88340befaa0"],
        ["p","f831caf722214748c72db4829986bd0cbb2bb8b3aeade1c959624a52a9629046"],
        ["d","1f7db84fdf986cea2fa1d70f2120ad85"], // Unique ID
        ["e","9e0dfd2177ea9357f0c165ed134a86a3c07449676d8315e12d159932ff428e37"] // Policy ID
    ]
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-sdk"><a class="header" href="#rust-sdk">Rust SDK</a></h1>
<p>This section will show you how to use the Rust SDK.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installing-the-library"><a class="header" href="#installing-the-library">Installing the library</a></h1>
<custom-tabs category="lang">
<div slot="title">Rust</div>
<section>
<p>Add the <code>smartvaults-sdk</code> dependency in your <code>Cargo.toml</code> file:</p>
<pre><code class="language-toml">[dependencies]
smartvaults-sdk = { git = "https://github.com/smartvaults/smartvaults", tag = "vX.X.X" }
</code></pre>
<p>Note: you can specify a commit using <code>rev</code> instead of <code>tag</code>.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>Use a specific version:</p>
<pre><code class="language-toml">[dependencies]
smartvaults-sdk = { git = "https://github.com/smartvaults/smartvaults", tag = "v0.3.0" }
</code></pre>
<p>Use a specific commit:</p>
<pre><code class="language-toml">[dependencies]
smartvaults-sdk = { git = "https://github.com/smartvaults/smartvaults", rev = "383c186cb1df3ab5906978d6b313aed86d2698b1" }
</code></pre>
</section>
<div slot="title">Kotlin</div>
<section>
<p>To use the Kotlin language bindings for <code>smartvaults-sdk</code> in your Android project add the following to your gradle dependencies:</p>
<pre><code class="language-kotlin">repositories {
    mavenCentral()
}

dependencies { 
    implementation("io.smartvaults:smartvaults-sdk:&lt;version&gt;")
}
</code></pre>
<p>Import the library in your code:</p>
<pre><code class="language-kotlin">import io.smartvaults.sdk.*
</code></pre>
<p>To import nostr or nostr-sdk:</p>
<pre><code class="language-kotlin">import rust.nostr.protocol.*
import rust.nostr.sdk.*
</code></pre>
<h2 id="known-issues"><a class="header" href="#known-issues">Known issues</a></h2>
<h3 id="jna-dependency"><a class="header" href="#jna-dependency">JNA dependency</a></h3>
<p>Depending on the JVM version you use, you might not have the JNA dependency on your classpath. The exception thrown will be</p>
<pre><code class="language-bash">class file for com.sun.jna.Pointer not found
</code></pre>
<p>The solution is to add JNA as a dependency like so:</p>
<pre><code class="language-kotlin">dependencies {
    // ...
    implementation("net.java.dev.jna:jna:5.12.1")
}
</code></pre>
</section>
</custom-tabs><div style="break-before: page; page-break-before: always;"></div><h1 id="features"><a class="header" href="#features">Features</a></h1>
<p>The Rust SDK can be used both in <code>async/await</code> and <code>blocking</code> contexts.</p>
<p>By default, the SDK operate in <code>async</code> mode, so to use it in a blocking context, you have to specify the <code>blocking</code> feature:</p>
<pre><code class="language-toml">[dependencies]
smartvaults-sdk = { ..., features = ["blocking"] }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="constructors"><a class="header" href="#constructors">Constructors</a></h1>
<p>Let's start by constructing the <code>SmartVaults</code> struct.</p>
<p>There are 3 possible constructors: <code>generate</code>, <code>restore</code> and <code>open</code>.
All these when constructed return a ready to use client.</p>
<h2 id="generate"><a class="header" href="#generate">Generate</a></h2>
<p>This constructor generate a random <a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39</a> mnemonic and store
it in a local <a href="rust-sdk/./keychain/01-index.html">encrypted keychain</a>.</p>
<custom-tabs category="lang">
<div slot="title">Rust</div>
<section>
<pre><pre class="playground"><code class="language-rust no_run">use smartvaults_sdk::prelude::*;

<span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = SmartVaults::generate(
    "./your-base-path", // A local path where to store all the data
    "account-name", // This will be used for the keychain file name
    || Ok(String::from("password")), // Keychain encryption password
    || Ok(String::from("password")), // Confirmation of the above password
    WordCount::W24, // Number of mnemonic words (possible values are: 12, 18 or 24)
    || Ok(None), // Optional passphrase that will be stored in the keychain
    Network::Testnet, // The bitcoin network to use
)
.await?;
<span class="boring">}</span></code></pre></pre>
</section>
<div slot="title">Kotlin</div>
<section>
<pre><code class="language-kotlin">import io.smartvaults.sdk.*

// TODO
</code></pre>
</section>
</custom-tabs>
<h2 id="restore"><a class="header" href="#restore">Restore</a></h2>
<p>This constructor restore a <a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39</a> mnemonic and store
it in a local <a href="rust-sdk/./keychain/01-index.html">encrypted keychain</a>.</p>
<pre><pre class="playground"><code class="language-rust no_run">use smartvaults_sdk::prelude::*;

<span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = SmartVaults::restore(
    "./your-base-path", // A local path where to store all the data
    "account-name", // This will be used for the keychain file name
    || Ok(String::from("password")), // Keychain encryption password
    || Ok(String::from("password")), // Confirmation of the above password
    || Ok(Mnemonic::from_str("your menmonic").unwrap()), // A BIP39 mnemonic
    || Ok(Some(String::from("my-optional-passphrase"))), // Optional passphrase that will be stored in the keychain
    Network::Testnet, // The bitcoin network to use
)
.await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="open"><a class="header" href="#open">Open</a></h2>
<p>This constructor open an <strong>already existing</strong> keychain.</p>
<pre><pre class="playground"><code class="language-rust no_run">use smartvaults_sdk::prelude::*;

<span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = SmartVaults::open(
    "./your-base-path",
    "account-name",
    || Ok(String::from("password")),
    Network::Testnet,
)
.await?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configs--relays"><a class="header" href="#configs--relays">Configs &amp; Relays</a></h1>
<p>Once the client is constructed, you can start editing the default configs and relays.</p>
<p>Note: both the configs and relays are persistent, so you <strong>not</strong> need to edit them every time.</p>
<h2 id="view-and-edit-configs"><a class="header" href="#view-and-edit-configs">View and edit configs</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Get the current configs
let config = client.config();

// View the current configs
println!("Current electrum endpoint: {}", config.electrum_endpoint().await?);
println!("Current proxy: {}", config.proxy().await.ok());
println!("Current block explorer: {}", config.block_explorer().await?);

// Edit the electrum endpoint
config.set_electrum_endpoint(Some("tcp://127.0.0.1:50001")).await;

// Edit the block explorer url
let url = Url::parse("http://myblockexplorer.local")?;
config.set_block_explorer(Some(url)).await;

// Save the configs in the persistent file
config.save().await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="view-relays"><a class="header" href="#view-relays">View relays</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

for (relay_url, relay) in client.relays().await.into_iter() {
    let stats = relay.stats();
    println!("Url: {relay_url}");
    println!("Status: {}", relay.status().await);
    println!("Attempts: {}", stats.attempts());
    println!("Success: {}", stats.success());
    println!("Bytes sent: {}", stats.bytes_sent());
    println!("Bytes received: {}", stats.bytes_received());
    if let Some(latency) = stats.latency().await {
        println!("Latency: {} ms", latency.as_millis());
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="edit-relays"><a class="header" href="#edit-relays">Edit relays</a></h2>
<pre><pre class="playground"><code class="language-rust no_run">use std::net::{Ipv4Addr, SocketAddr, SocketAddrV4};
<span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Add a relay (without proxy)
client.add_relay("wss://you.relay.com", None).await?;

// Add a relay (with proxy)
let proxy = Some(SocketAddr::V4(SocketAddrV4::new(Ipv4Addr::LOCALHOST, 9050)));
client.add_relay("wss://you.relay2.com", Some(proxy)).await?;

// Remove a relay
client.remove_relay("wss://you.relay.com").await?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="profile--contacts"><a class="header" href="#profile--contacts">Profile &amp; Contacts</a></h1>
<h2 id="profile"><a class="header" href="#profile">Profile</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Get your profile (public key and metadata)
let profile: User = client.get_profile().await?;
println!("My public key: {}", profile.public_key());
println!("My name: {}", profile.name());
println!("My metadata: {:#?}", profile.metadata());

// Edit metadata
let metadata = profile.metadata().name("myname").display_name("My Name").nip05("myname@example.com");
client.set_metadata(metadata).await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="addremove-contacts"><a class="header" href="#addremove-contacts">Add/Remove contacts</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Public key from hex
let public_key = XOnlyPublicKey::from_str("ea527e059759d368a55253270454e58e9d6e4fe2e98d302d6e01821fa973259d")?;
// Public key from bech32
let public_key = XOnlyPublicKey::from_bech32("npub1aff8upvht8fk3f2j2vnsg48936wkunlzaxxnqttwqxppl2tnykwsahwngp")?;

// Add a contact
// This method will automatically request metadata of the contact
client.add_contact(public_key).await?;

// Remove a contact
let another_public_key: XOnlyPublicKey = ...;
client.remove_contact(another_public_key).await?;

// Get contact list
let list: Vec&lt;User&gt; = client.get_contacts().await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="get-metadata-of-a-generic-public-key"><a class="header" href="#get-metadata-of-a-generic-public-key">Get metadata of a generic public key</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let public_key: XOnlyPublicKey = ...;
// This method check if metadata for a public key exists in local database.
// If not exists, will return an empty `Metadata` struct and will request it to relays.
let metadata: Metadata = client.get_public_key_metadata(public_key).await?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="signers"><a class="header" href="#signers">Signers</a></h1>
<p>Signers are descriptors that you can share with contacts (or with other users) to simplify the
process of policies creation.</p>
<h2 id="the-smartvaults-signer"><a class="header" href="#the-smartvaults-signer">The SmartVaults signer</a></h2>
<p>The <code>SmartVaults</code> signer it's derived from your local seed.
It's use the following derivation path: <code>m/86'/&lt;coin&gt;'/784923'</code> (the <code>coin</code> depends on the selected <code>network</code>)</p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Save the SmartVaults signer (if not exists)
client.save_smartvaults_signer().await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="external-signers"><a class="header" href="#external-signers">External signers</a></h2>
<p>You can save external signers (like <code>AirGap</code> devices).</p>
<pre><pre class="playground"><code class="language-rust no_run">use std::str::FromStr;

<span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let fingerprint = Fingerprint::from_str("7356e457")?;
let descriptor: Descriptor&lt;DescriptorPublicKey&gt; = Descriptor::from_str("[7356e457/86'/1'/784923']tpubDCvLwbJPseNux9EtPbrbA2tgDayzptK4HNkky14Cw6msjHuqyZCE88miedZD86TZUb29Rof3sgtREU4wtzofte7QDSWDiw8ZU6ZYHmAxY9d/0/*")?;
let signer = Signer::airgap("Coldcard", "Description", fingerprint, descriptor)?;
client.save_signer(signer).await?;
<span class="boring">}</span></code></pre></pre>
<p>Note: <strong>only</strong> <code>taproot</code> descriptors are supported</p>
<h2 id="share-a-signer"><a class="header" href="#share-a-signer">Share a signer</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Get my signers
let signers: Vec&lt;GetSigner&gt; = client.get_signers().await?;

// Get the first signer
let signer_id = signers.first().unwrap().signer_id;

// Public key of the user to share the signer
let public_key: XOnlyPublicKey = ...;

// Share
client.share_signer(signer_id, public_key).await?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="policies"><a class="header" href="#policies">Policies</a></h1>
<p>In this section we'll see how to <code>create</code> a policy from a <code>template</code> or from a <code>custom descriptor</code> and how to <code>fund</code> it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates"><a class="header" href="#templates">Templates</a></h1>
<p>This library provide some <code>templates</code> to simplify the policies creation.
Currently the following templates are available:</p>
<ul>
<li>Multisig (M of N)</li>
<li>Social recovery: 1 spending key and N others with a <code>relative</code> timelock (funds can be spent after a sequence of N blocks)</li>
<li>Inheritance: 1 spending key and N others with an <code>absolute</code> timelock (funds can be spent after the block or timestamp X)</li>
<li>Hold: 1 spending key and a <code>relative</code> timelock</li>
</ul>
<h2 id="save-a-template"><a class="header" href="#save-a-template">Save a template</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let public_keys = vec![...]; // Nostr public keys of users involved in the policy
let template = ...; // See below examples
client
    .save_policy_from_template(
        "My Policy", // Name of the policy
        "Policy created from a template", // Description
        template,
        public_keys,
    )
    .await?;
<span class="boring">}</span></code></pre></pre>
<h3 id="examples-1"><a class="header" href="#examples-1">Examples</a></h3>
<p>To simplify the code below, I define all the descriptors used here:</p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::str::FromStr;
use smartvaults_sdk::core::miniscript::DescriptorPublicKey;

let key1 = DescriptorPublicKey::from_str("[7356e457/86'/1'/784923']tpubDCvLwbJPseNux9EtPbrbA2tgDayzptK4HNkky14Cw6msjHuqyZCE88miedZD86TZUb29Rof3sgtREU4wtzofte7QDSWDiw8ZU6ZYHmAxY9d/0/*").unwrap();
let key2 = DescriptorPublicKey::from_str("[4eb5d5a1/86'/1'/784923']tpubDCLskGdzStPPo1auRQygJUfbmLMwujWr7fmekdUMD7gqSpwEcRso4CfiP5GkRqfXFYkfqTujyvuehb7inymMhBJFdbJqFyHsHVRuwLKCSe9/0/*").unwrap();
let key3 = DescriptorPublicKey::from_str("[f3ab64d8/86'/1'/784923']tpubDCh4uyVDVretfgTNkazUarV9ESTh7DJy8yvMSuWn5PQFbTDEsJwHGSBvTrNF92kw3x5ZLFXw91gN5LYtuSCbr1Vo6mzQmD49sF2vGpReZp2/0/*").unwrap();
<span class="boring">}</span></code></pre></pre>
<h2 id="multisig-1-of-2"><a class="header" href="#multisig-1-of-2">Multisig 1 of 2</a></h2>
<p>Using the <code>key1</code> and <code>key2</code> to create a multisig <code>1 of 2</code></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use std::str::FromStr;
</span><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let template = PolicyTemplate::multisig(1, vec![key1, key2]);
<span class="boring">}</span></code></pre></pre>
<h2 id="social-recovery"><a class="header" href="#social-recovery">Social recovery</a></h2>
<p>Using <code>key1</code> as spending key and <code>key2</code> and <code>key3</code> as recovery keys with a <code>relative</code> timelock of <code>6 blocks</code></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let older = Sequence(6); // Relative timelock of 6 blocks
let recovery = RecoveryTemplate::social_recovery(2, vec![key2, key3], older);
let template = PolicyTemplate::recovery(key1, recovery);
<span class="boring">}</span></code></pre></pre>
<h2 id="inheritance"><a class="header" href="#inheritance">Inheritance</a></h2>
<p>Using <code>key1</code> as spending key and <code>key2</code> and <code>key3</code> as recovery with an <code>absolute</code> timelock set at block <code>840000</code></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let after = AbsoluteLockTime::from_height(840_000)?; // Absolute timelock (funds can be spent after block 840000)
let recovery = RecoveryTemplate::inheritance(2, vec![key2, key3], after);
let template = PolicyTemplate::recovery(key1, recovery);
<span class="boring">}</span></code></pre></pre>
<h2 id="hold"><a class="header" href="#hold">Hold</a></h2>
<p>Using a <code>single key</code> with a <code>relative</code> timelock</p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let older = Sequence(10_000);
let template = PolicyTemplate::hold(key1, older);
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-policies"><a class="header" href="#custom-policies">Custom policies</a></h1>
<p>If you need to save more complex policies that are not included in <a href="rust-sdk/08-policies/./02-templates.html">templates</a>, you can use the <code>save_policy</code> method:</p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let public_keys = vec![...]; // Nostr public keys of users involved in the policy
client
    .save_policy(
        "My custom policy", // Name of the policy
        "Custom policy", // Description
        "...", // Miniscript policy or already compiled descriptor
        public_keys,
    )
    .await?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="funding"><a class="header" href="#funding">Funding</a></h1>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Get first policy
let policy = client.get_policies().await?.first().unwrap();

// OR

// Get a specific policy by ID
let policy = client.get_policy_by_id(policy_id).await?;

// Get a new address
let GetAddress { address, .. } = client.get_address(policy.policy_id, AddressIndex::New).await?;
println!("Address: {}", address.assume_checked());
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proposals"><a class="header" href="#proposals">Proposals</a></h1>
<p>In this section we'll see how to create a <code>spending</code> proposal and how to <code>approve</code> and <code>finalize</code> it.</p>
<h2 id="spend"><a class="header" href="#spend">Spend</a></h2>
<p>Create a new <code>spending</code> proposal</p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let policy_id: EventId = ...; // Get from policies list or pass a specific event ID

// Create a new proposal
let proposal: Proposal = client
    .spend(
        policy_id,
        Address::from_str("mohjSavDdQYHRYXcS3uS6ttaHP8amyvX78")?, // Dastination address
        Amount::Custom(10_934), // Use `Amount::Max` to send all funds
        "Back to the faucet", // Description
        FeeRate::Priority(Priority::Medium), // Use `FeeRate::Rate(1.0)`` to specify the sat/vByte
        None, // Specify the UTXOs to use (optional)
        None, // Specify the policy path to use (needed only if exists a timelock in the policy descriptor)
        false, // Allow usage of UTXOs frozen by others proposals
    )
    .await?;
println!("New proposal: {proposal:#?}");
<span class="boring">}</span></code></pre></pre>
<h2 id="approvals"><a class="header" href="#approvals">Approvals</a></h2>
<p>Currently you can approve a proposal with the <code>seed</code> stored in the <a href="rust-sdk/./keychain/01-index.html">keychain</a> or use an <code>AirGap</code> signer and import
the signed PSBT.</p>
<h3 id="approve-with-the-seed"><a class="header" href="#approve-with-the-seed">Approve with the seed</a></h3>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let proposal_id: EventId = ...; // Id of a proposal
// Ex. let proposal_id: EventId = proposal.proposal_id;

// Approve a proposal with the stored seed
client.approve(proposal_id).await?;
<span class="boring">}</span></code></pre></pre>
<h3 id="approve-with-a-signed-psbt-airgap-signer"><a class="header" href="#approve-with-a-signed-psbt-airgap-signer">Approve with a signed PSBT (AirGap signer)</a></h3>
<pre><pre class="playground"><code class="language-rust no_run">use std::str::FromStr;
use smartvaults_sdk::core::bitcoin::psbt::PartiallySignedTransaction;

<span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let proposal_id: EventId = ...; // Id of a proposal
// Ex. let proposal_id: EventId = proposal.proposal_id;

// Approve a proposal with a PSBT
let signed_psbt = PartiallySignedTransaction::from_str("base64-psbt")?;
client.approve_with_signed_psbt(proposal_id, signed_psbt).await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="finalization"><a class="header" href="#finalization">Finalization</a></h2>
<p>When the proposal is signed, you can finalize it.</p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let proposal_id: EventId = ...;
let proposal: GetProposal = client.get_proposal_by_id(proposal_id).await?;

// Check if proposal is signed
if proposal.signed {
    // Finalize the proposal and broadcast the TX
    client.finalize(proposal_id).await?;
} else {
    println!("This proposal is not fully signed yet!");
}
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="connect"><a class="header" href="#connect">Connect</a></h1>
<p>In this section we'll see how to connect to a Web App using the <a href="https://github.com/nostr-protocol/nips/blob/master/46.md">NIP46</a> (Nostr Connect).</p>
<h2 id="initialize-a-new-session"><a class="header" href="#initialize-a-new-session">Initialize a new session</a></h2>
<p>To initialize a new session, you'll need a nostr connect URI (it's provided from the app you want connect to).</p>
<pre><pre class="playground"><code class="language-rust no_run">use std::str::FromStr;

<span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Parse URI
let uri = NostrConnectURI::forom_str("nostrconnect://f0d056e4bc98d52d53df73fd2f3dac287b1f5f2d868414172759d663987a95e3?metadata=%7B%22name%22%3A%22Smart%20Vaults%22%2C%22description%22%3A%22Bitcoin%20multi-custody%20signature%20orchestration%22%2C%22url%22%3A%22https%3A%2F%2Fsmartvaults.app%22%2C%22icons%22%3A%5B%22https%3A%2F%2Fsmartvaults.app%2Ffavicon.ico%22%5D%7D&amp;relay=wss%3A%2F%2Ftest.relay.report")?;

// Initialize session
client.new_nostr_connect_session(uri).await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="get-approve-and-reject-requests"><a class="header" href="#get-approve-and-reject-requests">Get, approve and reject requests</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Get pending requests
let approved: bool = false;
let requests: Vec&lt;NostrConnectRequest&gt; = client.get_nostr_connect_requests(approved).await?;

let first_req: NostrConnectRequest = requests.first().unwrap();
let second_req: NostrConnectRequest = requests.get(1).unwrap();

// Approve a request
client.approve_nostr_connect_request(first_req.event_id).await?;

// Reject a request
client.reject_nostr_connect_request(second_req.event_id).await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="disconnect-from-a-session"><a class="header" href="#disconnect-from-a-session">Disconnect from a session</a></h2>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Get current sessions
let sessions: Vec&lt;(NostrConnectURI, Timestamp)&gt; = client.get_nostr_connect_sessions().await?;

// Disconnect from all sessions
for (uri, _timestamp) in sessions.into_iter() {
    // Disconnect session from app public key
    client.disconnect_nostr_connect_session(uri.public_key).await?;
}
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="keychain"><a class="header" href="#keychain">Keychain</a></h1>
<p>This section will show you how to manage the <code>keychain</code>.</p>
<h2 id="definition"><a class="header" href="#definition">Definition</a></h2>
<p>Keychain means a <code>seed</code> plus an optional list of <code>passphrases</code>.</p>
<h2 id="store"><a class="header" href="#store">Store</a></h2>
<p>The <code>keychian</code> it's stored in a file called <code>keechain</code>. It's encrypted using AES-256 in CBC mode and XChaCha20Poly1305: <code>XChaCha20Poly1305(AES256CBC(keychain))</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="change-password"><a class="header" href="#change-password">Change password</a></h1>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

client.change_password(
    || Ok(String::from("current-password")), // Current password
    || Ok(String::from("new-password")), // New password
    || Ok(String::from("new-password")), // Confirmation of new password
)?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="secrets"><a class="header" href="#secrets">Secrets</a></h1>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

let secp = Secp256k1::new();

let network: Network = client.network();
let keychain: Keychain = client.keychain();
let secrets: Secrets = keychain.secrets(network, &amp;secp)?;

println!("Entropy: {}", secrets.entropy);
println!("Mnemonic: {}", secrets.mnemonic);
if let Some(passphrase) = &amp;secrets.passphrase {
    println!("Passphrase: {}", passphrase);
}
println!("Seed (hex): {}", secrets.seed_hex);
println!("Root Key (BIP32): {}", secrets.root_key);
println!("Fingerprint: {}", secrets.fingerprint);
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wipe"><a class="header" href="#wipe">Wipe</a></h1>
<p>Delete the <code>keychain</code></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use smartvaults_sdk::prelude::*;
</span><span class="boring">
</span><span class="boring">#[tokio::main]
</span><span class="boring">async fn main() {
</span>let client = ...; // The client that you before constructed

// Delete the keychain
client.wipe("your-password")?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h1>
<h2 id="install-dependencies"><a class="header" href="#install-dependencies">Install dependencies</a></h2>
<pre><code class="language-shell">npm install @smontero/smartvaults-js-client @smontero/smartvaults-wasm @smontero/nostr-ual --save
</code></pre>
<h2 id="import-modules"><a class="header" href="#import-modules">Import modules</a></h2>
<pre><code class="language-javascript">import { NostrClient, SmartVaults, Contact, Keys } from '@smontero/smartvaults-js-client';
import { DirectPrivateKeyAuthenticator } from '@smontero/nostr-ual'
import {
  Wallet,
  miniscript_to_descriptor as miniScriptToDescriptor,
  can_finalize_psbt as canFinalizePsbt,
  get_trx_id as getTrxIdWasm,
  get_fee as getFeeWasm,
  MiniscriptBuilder,
  get_psbt_utxos as getPsbtUtxos,
  descriptor_to_miniscript as descriptorToMiniscript
} from '@smontero/smartvaults-wasm'
</code></pre>
<h2 id="initializing-smartvaults"><a class="header" href="#initializing-smartvaults">Initializing <code>SmartVaults</code></a></h2>
<h3 id="parameters-for-initialization"><a class="header" href="#parameters-for-initialization">Parameters for Initialization</a></h3>
<ol>
<li><code>authenticator</code>: An instance of an Authenticator</li>
<li><code>bitcoinUtil</code>: Utility functions related to Bitcoin transactions</li>
<li><code>nostrClient</code>: An instance of NostrClient for interacting with Nostr relays</li>
</ol>
<pre><code class="language-javascript">// Define the authenticator
const myKeys = new Keys()
const authenticator = new DirectPrivateKeyAuthenticator(myKeys.privateKey)

// Define the bitcoin utility functions
const ENDPONIT = 'https://mempool.space/testnet/api'
const NETWORK = 'testnet'
const STOP_GAP = 20 // Stop searching addreses for transactions after this number of consecutive addresses with no transactions is found
const bitcoinUtil = {
        walletSyncTimeGap: 3, // Minutes that have to pass after the last sync, to require another sync when performing an operation
        toDescriptor: miniScriptToDescriptor,
        createWallet: (descriptor) =&gt; {
          return new Wallet(
            descriptor,
            ENDPONIT,
            NETWORK,
            STOP_GAP
          )
        },
        canFinalizePsbt: (psbts) =&gt; canFinalizePsbt(psbts),
        getTrxId: (trx) =&gt; getTrxIdWasm(trx),
        getFee: (psbt) =&gt; getFeeWasm(psbt),
        getPsbtUtxos: (psbt) =&gt; getPsbtUtxos(psbt),
        toMiniscript: (descriptor) =&gt; descriptorToMiniscript(descriptor)
}

// Define the Nostr client
const nostrClient = new NostrClient(['wss://test.relay.report'])

// Initialize SmartVaults
const smartVaults = new SmartVaults ({authenticator, bitcoinUtil, nostrClient})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-profile-and-contacts"><a class="header" href="#set-profile-and-contacts">Set profile and Contacts</a></h1>
<p>In this section we show how to manage user profiles and contacts.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ol>
<li><strong>Setting up Metadata and User Profiles</strong></li>
<li><strong>Retrieving the User Profile</strong></li>
<li><strong>Creating a New Contact</strong></li>
<li><strong>Adding or Updating a Contact</strong></li>
<li><strong>Fetching Contacts</strong></li>
<li><strong>Fetching Contacts with Metadata</strong></li>
<li><strong>Fetching Recommended Contacts</strong></li>
<li><strong>Removing a Contact</strong></li>
</ol>
<hr />
<h3 id="setting-up-metadata-and-user-profiles"><a class="header" href="#setting-up-metadata-and-user-profiles">Setting up Metadata and User Profiles</a></h3>
<p>To set up a user profile, you need to use the <code>setProfile</code> method. Create a metadata object to include the details you wish to set in the profile.</p>
<pre><code class="language-javascript">const metadata = { name: 'Bob', about: 'Learning about Smart Vaults!' };
await smartVaults.setProfile(metadata);
</code></pre>
<hr />
<h3 id="retrieving-the-user-profile"><a class="header" href="#retrieving-the-user-profile">Retrieving the User Profile</a></h3>
<p>To fetch a profile, use the <code>getProfile</code> method.</p>
<pre><code class="language-javascript">const myPublicKey = authenticator.getPublicKey();
const myProfile = await smartVaults.getProfile(myPublicKey);
</code></pre>
<hr />
<h3 id="creating-a-new-contact"><a class="header" href="#creating-a-new-contact">Creating a New Contact</a></h3>
<p>To create a new contact, let's first generate a new set of Keys.</p>
<pre><code class="language-javascript">const contactKeys = new Keys();
const contactAuthenticator = new DirectPrivateKeyAuthenticator(contactKeys.privateKey);
const contactPubKey = contactAuthenticator.getPublicKey();
</code></pre>
<hr />
<h3 id="creating-and-adding-a-contact"><a class="header" href="#creating-and-adding-a-contact">Creating and adding a contact</a></h3>
<p>The <code>upsertContacts</code> method allows you add a new contact.</p>
<pre><code class="language-javascript">const contact = new Contact({ publicKey: contactPubKey });
await smartVaults.upsertContacts(contact);
</code></pre>
<hr />
<h3 id="fetching-contacts"><a class="header" href="#fetching-contacts">Fetching Contacts</a></h3>
<p>You can fetch your existing contacts using the <code>getContacts</code> method.</p>
<pre><code class="language-javascript">const contacts = await smartVaults.getContacts();
</code></pre>
<hr />
<h3 id="fetching-contacts-along-with-their-metadata"><a class="header" href="#fetching-contacts-along-with-their-metadata">Fetching Contacts along with their metadata</a></h3>
<p>To fetch contacts along with their profile metadata, you can use the <code>getContactProfiles</code> method.</p>
<pre><code class="language-javascript">const contactsProfiles = await smartVaults.getContactProfiles();
</code></pre>
<h3 id="fetching-recommended-contacts"><a class="header" href="#fetching-recommended-contacts">Fetching Recommended Contacts</a></h3>
<p>When 'user A' adds 'user B' as a contact, 'user A' is automatically added as a recommended contact for 'user B'. To fetch recommended contacts, use the <code>getRecommendedContacts</code> method.</p>
<pre><code class="language-javascript">const recommendedContacts = await smartVaults.getRecommendedContacts();
</code></pre>
<h3 id="removing-a-contact"><a class="header" href="#removing-a-contact">Removing a Contact</a></h3>
<p>To remove a contact, use the <code>removeContacts</code> method.</p>
<pre><code class="language-javascript">await smartVaults.removeContacts(contactPubKey);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="signers-1"><a class="header" href="#signers-1">Signers</a></h1>
<p>This guide walks you through the process of fetching your owned signers and sharing them with your contacts.</p>
<h2 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of Contents</a></h2>
<ol>
<li><strong>Fetching Owned Signers</strong></li>
<li><strong>Sharing an Owned Signer with a Contact</strong></li>
</ol>
<hr />
<h3 id="fetching-owned-signers"><a class="header" href="#fetching-owned-signers">Fetching Owned Signers</a></h3>
<p>To get the list of signers that you own, you can use the <code>getOwnedSigners</code> method.</p>
<pre><code class="language-javascript">const mySigners = await smartVaults.getOwnedSigners();
const mySigner = mySigners[0]; // For this example, we are assuming that you have at least one signer
</code></pre>
<hr />
<h3 id="sharing-an-owned-signer-with-a-contact"><a class="header" href="#sharing-an-owned-signer-with-a-contact">Sharing an Owned Signer with a Contact</a></h3>
<p>To share a signer with a contact, use the <code>saveSharedSigner</code> method. The method takes two parameters: the <code>ownedSigner</code> you wish to share and the public keys of the contacts (<code>pubKeys</code>).</p>
<pre><code class="language-javascript">const pubKeys = [contactPubKey]; // Replace with the actual public keys of the contacts you wish to share the signer with
const sharedSigners = await smartVaults.saveSharedSigner(mySigner, pubKeys);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vaults"><a class="header" href="#vaults">Vaults</a></h1>
<p>There cannot be Smart Vaults without Vaults. In this section, we will learn how to create and manage vaults. We start with some definitions.</p>
<ol>
<li><strong>Vault</strong> is a Bitcoin Wallet.</li>
<li><strong>Policy</strong> is a set of rules that define how a vault can be managed.</li>
<li><strong>Vault Template</strong> is Vault with a predefined Policy.</li>
</ol>
<p>While it is true that a Policy is not exactly the same as a descriptor, we define the <code>Policy event</code> as a Nostr event with kind <code>9289</code> that (in its encryped content) contains a descriptor.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creating-a-vault"><a class="header" href="#creating-a-vault">Creating a Vault</a></h1>
<p>In this example, we will create a 2-of-2 multisig vault, but as you will see, the process is similar for other types of vaults.</p>
<h3 id="fetching-the-signers-key"><a class="header" href="#fetching-the-signers-key">Fetching the Signer's Key</a></h3>
<p>To create a vault we need keys, once you have fetched your signers, get the key for the signer you wish to use.</p>
<pre><code class="language-javascript">const mySignerKey = mySigner.key;
</code></pre>
<hr />
<h3 id="getting-the-co-signers-key"><a class="header" href="#getting-the-co-signers-key">Getting the Co-Signer's Key</a></h3>
<p>Retrieve the key of a co-signer to include in the multisig vault.</p>
<pre><code class="language-javascript">const coSigner = await smartVaults.getSharedSigners();
const coSignerKey = coSigner[0].key;
</code></pre>
<hr />
<h3 id="setting-the-threshold-and-creating-miniscript"><a class="header" href="#setting-the-threshold-and-creating-miniscript">Setting the Threshold and Creating Miniscript</a></h3>
<p>Create a miniscript that specifies the threshold and keys for the 2-of-2 multisig.</p>
<pre><code class="language-javascript">const threshold = 2;
const keys = [mySignerKey, coSignerKey];
const miniscript = MiniscriptBuilder.multisig({threshold, keys});
</code></pre>
<hr />
<h3 id="defining-additional-parameters"><a class="header" href="#defining-additional-parameters">Defining Additional Parameters</a></h3>
<p>Define other necessary parameters, like the name and description of the vault, and the public keys of vault participants.</p>
<pre><code class="language-javascript">const name = 'My First Vault';
const description = "2 of 2 Multisig";
const nostrPublicKeys = [myPublicKey, contactPubKey];
</code></pre>
<hr />
<h3 id="creating-the-vault"><a class="header" href="#creating-the-vault">Creating the Vault</a></h3>
<p>Finally, create the vault by invoking the <code>savePolicy</code> method.</p>
<pre><code class="language-javascript">await smartVaults.savePolicy({ name, description, miniscript, nostrPublicKeys });
</code></pre>
<p>Notice that the only assumption the <code>savePolicy</code> methods makes about the miniscript is that it is a valid miniscript. This means that you can use any miniscript you want, the Smart Vaults Web app offers a few templates to make it easier to create common types of vaults, but also allows you to create custom vaults.</p>
<hr />
<h3 id="basic-fetching-of-vaults"><a class="header" href="#basic-fetching-of-vaults">Basic Fetching of Vaults</a></h3>
<p>To fetch vaults without any specific pagination, you can simply call the <code>getPolicies</code> method without any arguments.</p>
<pre><code class="language-javascript">const policies = await smartVaults.getPolicies();
</code></pre>
<p>This will return an array of <code>PublishedPolicy</code> objects.</p>
<hr />
<h3 id="deleting-a-vault"><a class="header" href="#deleting-a-vault">Deleting a Vault</a></h3>
<p>To delete a vault, you can use the <code>deletePolicy</code> method.</p>
<pre><code class="language-javascript">await smartVaults.deletePolicies(policyId);
</code></pre>
<p>We will explore the vault methods in more detail in the next section.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creating-proposals"><a class="header" href="#creating-proposals">Creating Proposals</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The <code>spend</code> method is used to create a spending proposal, first, let's look at the method definition.</p>
<h2 id="method-signature"><a class="header" href="#method-signature">Method Signature</a></h2>
<pre><code class="language-typescript">spend(payload: SpendProposalPayload): Promise&lt;PublishedSpendingProposal&gt;
</code></pre>
<h3 id="parameters"><a class="header" href="#parameters">Parameters</a></h3>
<h4 id="payload-spendproposalpayload"><a class="header" href="#payload-spendproposalpayload"><code>payload: SpendProposalPayload</code></a></h4>
<p>The payload for the spending proposal.</p>
<ul>
<li><code>policy</code>: PublishedPolicy object.</li>
<li><code>to_address</code>: The recipient's address.</li>
<li><code>description</code>: Description of the proposal.</li>
<li><code>amountDescriptor</code>: Amount to be spent.</li>
<li><code>feeRatePriority</code>: Fee rate priority (e.g., 'low', 'medium', 'high').</li>
<li><code>policyPath</code>: Policy path.</li>
<li><code>utxos</code>: List of unspent transaction outputs (UTXOs) to be used. (Optional)</li>
<li><code>useFrozenUtxos</code>: Flag to specify whether frozen UTXOs can be used. (Optional)</li>
</ul>
<h3 id="returns"><a class="header" href="#returns">Returns</a></h3>
<pre><code class="language-typescript">Promise&lt;PublishedSpendingProposal&gt;
</code></pre>
<p>A Promise that resolves to a <code>PublishedSpendingProposal</code> object representing the published spending proposal.</p>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<p>The method may throw various errors under certain conditions:</p>
<ul>
<li><strong>Invalid UTXOs</strong>: If the provided UTXOs are invalid.</li>
<li><strong>Frozen UTXOs Without Flag</strong>: If frozen UTXOs are provided but <code>useFrozenUtxos</code> is not set to <code>true</code>.</li>
<li><strong>Transaction Building Error</strong>: If an error occurs while building the transaction.</li>
<li><strong>Publishing Error</strong>: If an error occurs while publishing the proposal.</li>
</ul>
<h2 id="example-usage"><a class="header" href="#example-usage">Example Usage</a></h2>
<p>Here's an example code snippet that demonstrates how to use the <code>spend</code> method to create a spending proposal:</p>
<pre><code class="language-javascript">const payload = {
  policy: somePublishedPolicyObject,
  to_address: "abc123",
  description: "A spending proposal",
  amountDescriptor: 10,
  feeRatePriority: 'high',
  policyPath: new Map([['nodeId',[0,1,2]]]) // Optional but needed if the policy descriptor has more than one path,
  utxos: ["utxo1", "utxo2"], // Optional
  useFrozenUtxos: false // Optional
};

const spendingProposal = await spend(payload);

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creating-proposals-1"><a class="header" href="#creating-proposals-1">Creating Proposals</a></h1>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>The <code>spend</code> method is used to create a spending proposal, first, let's look at the method definition.</p>
<h2 id="method-signature-1"><a class="header" href="#method-signature-1">Method Signature</a></h2>
<pre><code class="language-typescript">spend(payload: SpendProposalPayload): Promise&lt;PublishedSpendingProposal&gt;
</code></pre>
<h3 id="parameters-1"><a class="header" href="#parameters-1">Parameters</a></h3>
<h4 id="payload-spendproposalpayload-1"><a class="header" href="#payload-spendproposalpayload-1"><code>payload: SpendProposalPayload</code></a></h4>
<p>The payload for the spending proposal.</p>
<ul>
<li><code>policy</code>: PublishedPolicy object.</li>
<li><code>to_address</code>: The recipient's address.</li>
<li><code>description</code>: Description of the proposal.</li>
<li><code>amountDescriptor</code>: Amount to be spent.</li>
<li><code>feeRatePriority</code>: Fee rate priority (e.g., 'low', 'medium', 'high').</li>
<li><code>policyPath</code>: Policy path.</li>
<li><code>utxos</code>: List of unspent transaction outputs (UTXOs) to be used. (Optional)</li>
<li><code>useFrozenUtxos</code>: Flag to specify whether frozen UTXOs can be used. (Optional)</li>
</ul>
<h3 id="returns-1"><a class="header" href="#returns-1">Returns</a></h3>
<pre><code class="language-typescript">Promise&lt;PublishedSpendingProposal&gt;
</code></pre>
<p>A Promise that resolves to a <code>PublishedSpendingProposal</code> object representing the published spending proposal.</p>
<h2 id="errors-1"><a class="header" href="#errors-1">Errors</a></h2>
<p>The method may throw various errors under certain conditions:</p>
<ul>
<li><strong>Invalid UTXOs</strong>: If the provided UTXOs are invalid.</li>
<li><strong>Frozen UTXOs Without Flag</strong>: If frozen UTXOs are provided but <code>useFrozenUtxos</code> is not set to <code>true</code>.</li>
<li><strong>Transaction Building Error</strong>: If an error occurs while building the transaction.</li>
<li><strong>Publishing Error</strong>: If an error occurs while publishing the proposal.</li>
</ul>
<h2 id="example-usage-1"><a class="header" href="#example-usage-1">Example Usage</a></h2>
<p>Here's an example code snippet that demonstrates how to use the <code>spend</code> method to create a spending proposal:</p>
<pre><code class="language-javascript">const payload = {
  policy: somePublishedPolicyObject,
  to_address: "abc123",
  description: "A spending proposal",
  amountDescriptor: 10,
  feeRatePriority: 'high',
  policyPath: new Map([['nodeId',[0,1,2]]]) // Optional but needed if the policy descriptor has more than one path,
  utxos: ["utxo1", "utxo2"], // Optional
  useFrozenUtxos: false // Optional
};

const spendingProposal = await spend(payload);

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fetching-proposals"><a class="header" href="#fetching-proposals">Fetching Proposals</a></h1>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>The Smart Vaults JS library  provides multiple methods for fetching proposals.</p>
<h2 id="available-methods-for-fetching-proposals"><a class="header" href="#available-methods-for-fetching-proposals">Available Methods for Fetching Proposals</a></h2>
<h3 id="1-getproposals"><a class="header" href="#1-getproposals">1. <code>getProposals()</code></a></h3>
<p>This method fetches all proposals without any filters.</p>
<pre><code class="language-javascript">const proposals = await smartVaults.getProposals();
</code></pre>
<p>Of course, you can also use it with pagination options.</p>
<pre><code class="language-javascript">const newProposals = await smartVaults.getProposals({since: someRecentDate });
</code></pre>
<h3 id="2-getproposalsbyidproposalids-array"><a class="header" href="#2-getproposalsbyidproposalids-array">2. <code>getProposalsById(proposalIds: Array)</code></a></h3>
<p>Fetches proposals based on their IDs.</p>
<pre><code class="language-javascript">const specificProposals = await smartVaults.getProposalsById([someProposalId, anotherProposalId]);
</code></pre>
<h3 id="3-getproposalsbypolicyidpolicyids-array"><a class="header" href="#3-getproposalsbypolicyidpolicyids-array">3. <code>getProposalsByPolicyId(policyIds: Array)</code></a></h3>
<p>Fetches proposals based on their associated policy IDs.</p>
<pre><code class="language-javascript">const policyBasedProposals = await smartVaults.getProposalsByPolicyId([somePolicyId, anotherPolicyId]);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="approvals-1"><a class="header" href="#approvals-1">Approvals</a></h1>
<p>We define an <code>Approval</code> as a Nostr event with kind <code>9291</code>, that (in its encryped content) contains a signed PSBT. Currently, an approval can be created in two ways:</p>
<ol>
<li>Using the Smart Vaults desktop app.</li>
<li>Using the Smart Vaults iOs app.</li>
</ol>
<h2 id="approvals-and-signers"><a class="header" href="#approvals-and-signers">Approvals and signers</a></h2>
<p>An approval can only be created using a valid signer. The valid signers are defined in the policy of the vault from which the proposal was created.</p>
<h2 id="approvals-and-proposals"><a class="header" href="#approvals-and-proposals">Approvals and proposals</a></h2>
<p>An approval is always associated with a proposal. The proposal can only be finalized when all the required approvals are created.</p>
<h2 id="fetching-approvals"><a class="header" href="#fetching-approvals">Fetching approvals</a></h2>
<p>To fecth approvals, you can use the 'getApprovals' method.</p>
<pre><code class="language-javascript">const approvals = await smartVaults.getApprovals();
</code></pre>
<p>This method retrives all the approvals that you or the members your vaults have created.</p>
<h2 id="fetching-approvals-associated-with-a-proposal"><a class="header" href="#fetching-approvals-associated-with-a-proposal">Fetching approvals associated with a proposal</a></h2>
<p>In practice, you will want to fetch the approvals associated with a given proposal. To do so, you can use the 'getApprovalsByProposalId' method.</p>
<pre><code class="language-javascript">const approvals = await smartVaults.getApprovalsByProposalId(proposalId);
</code></pre>
<h2 id="approvals-and-proposal-status"><a class="header" href="#approvals-and-proposal-status">Approvals and proposal status</a></h2>
<p>When you fetch a proposal, you can see the status of the proposal. The status can be one of the following:</p>
<ol>
<li>'Unsigned': The proposal has not been signed by all the required signers.</li>
<li>'Signed': The proposal has been signed by all the required signers.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="completed-proposals"><a class="header" href="#completed-proposals">Completed proposals</a></h1>
<p>We define a 'Completed Proposal' as a Nostr event with Kind '9292' that (in its encryped content) contains a Bitcoin transaction.
A completed proposal can only be created when the proposal has been approved (signed) by all the participants.</p>
<h2 id="creating-a-completed-proposal"><a class="header" href="#creating-a-completed-proposal">Creating a Completed Proposal</a></h2>
<p>To create a Completed Proposal, we use the 'finalizeSpendingProposal' method.</p>
<pre><code class="language-javascript">const completedProposal = await smartVaults.finalizeSpendingProposal(proposalId);
</code></pre>
<p>The completedProposal object contains the transaction ID of the Bitcoin transaction that was broadcasted.
When the Completed Proposal is created, the associated Proposal is automatically deleted. If you decided to use frozen UXTOS, the proposals that share the same UTXOs will also be deleted.</p>
<div style="break-before: page; page-break-before: always;"></div><div align="center">
  <img src="articles/../SV-Logo-Vertical-Black.svg" width=400/>
</div>
<h1 id="introducción-a-miniscript"><a class="header" href="#introducción-a-miniscript">Introducción a Miniscript</a></h1>
<h2 id="introducción"><a class="header" href="#introducción">Introducción</a></h2>
<p>En este artículo hablaremos sobre Miniscript, intentado cubrir las ideas principales, las cuales creemos de interés para cualquier persona que esté interesada en empezar a usar esta poderosa herramienta.</p>
<p>La mejor forma de introducirse a una tecnología nueva es, como sabemos, leyendo su documentación, la documentación más completa sin duda es la que podemos encontrar en: <a href="https://bitcoin.sipa.be/miniscript/">https://bitcoin.sipa.be/miniscript/</a> , escrita por Pieter Wuille, uno de los creadores de Miniscript, en ella encontramos la definición que utilizaremos en este artículo:</p>
<div style="text-align: center; font-style:italic ;">
“Miniscript is a language for writing (a subset of) Bitcoin Scripts in a structured way, enabling analysis, composition, generic signing and more”
</div>
<p>Cuya traducción literal al español es:</p>
<div style="text-align: center; font-style:italic ;">
“Miniscript es un lenguaje para escribir (un subconjunto de) Bitcoin Scripts de una manera estructurada, habilitando el análisis, composición, firmado genérico y más”
</div>
<p>Por lo tanto Miniscript es:</p>
<div style="text-align: center; font-style:italic ;">
Un lenguaje para escribir un subconjunto de Bitcoin Scripts.
</div>
<p>Primero, comenzaremos comentando sobre algunos de los conceptos que aparecen en la definición.</p>
<h2 id="bitcoin-script"><a class="header" href="#bitcoin-script">Bitcoin Script</a></h2>
<p>Si una divisa ha de ser de alguna utilidad, sin duda es necesario que esta pueda ser transferida.</p>
<p>Por lo tanto es necesario definir un mecanismo que permita tal transferencia. Adicionalmente, tal mecanismo debe poder asegurar el cumplimiento de ciertas condiciones, por ejemplo, que la persona que transfiere la divisa tenga el derecho de hacerlo.</p>
<p>En el caso de Bitcoin, el lenguaje que permite definir (y comprobar) estas condiciones se conoce como Bitcoin Script.</p>
<p>Bitcoin Script es un lenguaje de programación relativamente simple, pero que, como veremos, puede ser difícil de usar.</p>
<p>En las siguientes secciones, siempre que utilzemos la palabra <em>script</em> nos referiremos a un Bitcoin Script.</p>
<h2 id="estructura"><a class="header" href="#estructura">Estructura</a></h2>
<p>Todo lenguaje implica estructura, la estructura de miniscript, nos dice la definición, habilita entre otras cosas:</p>
<ol>
<li>Análisis</li>
<li>Composición</li>
</ol>
<h2 id="análisis"><a class="header" href="#análisis">Análisis</a></h2>
<p>El análisis es uno de esos conceptos que cuya definición es más clara cuando se le asigna un apellido.</p>
<p>Algunos de los análisis que Miniscript facilita son:</p>
<ul>
<li>Análisis de condiciones de gasto: ¿Cuáles son las condiciones de gasto de un script?</li>
<li>Análisis de seguridad: ¿Es posible que un script sea maleable?</li>
<li>Análisis de costos: ¿Cuál será el costo de usar un script?</li>
</ul>
<h2 id="composición"><a class="header" href="#composición">Composición</a></h2>
<p>La composición es el acto de juntar dos o más cosas para formar una nueva.</p>
<p>En el caso de Miniscript, la composición se refiere a la habilidad de juntar dos o más fragmentos (scripts) para formar uno nuevo.</p>
<h2 id="subconjunto"><a class="header" href="#subconjunto">Subconjunto</a></h2>
<p>Para bien o para mal la palabra subconjunto trae consigo una connotación intuitiva, y como toda intuición, no siempre está en lo correcto, un ejemplo bastará:</p>
<div style="text-align: center; font-style:italic ;">
El agua potable es un subconjunto de los líquidos
</div>
<p>Mientras que es cierto que el conjunto de los líquidos tiene mucho más que ofrecer que solo agua, es fácil ver porque en nuestro dia a dia nos interesa solo un subconjunto en particular.</p>
<p>Lo mismo es cierto en el caso de Miniscript: el subconjunto que se selecciona es tal que nos permite trabajar con Bitcoin Script sin preocuparnos de, por accidente o intención, "consumir líquidos nocivos para la salud".</p>
<p>Aunque el comentario anterior puede parecer trivial, en realidad, encapsula la motivación principal para usar miniscript:</p>
<div style="text-align: center; font-style:italic ;">
Usar Bitcoin Script es difícil.
</div>
<p>En particular, con Bitcoin Script es difícil realizar los análisis mencionados en la sección anterior, a decir:</p>
<ul>
<li>Determinar si un script es <em>correcto</em>.</li>
<li>Determinar si un script es seguro (i.e no es propenso a ser maleable).</li>
<li>Estimar fees (i.e tamaño de una transacción en el peor de los casos)</li>
</ul>
<p>Antes de continuar nuestra discusión, conviene introducir la siguiente definición:</p>
<p><strong>Condición de gasto:</strong> es el conjunto de condiciones mínimas que, al cumplirse, permiten usar con éxito un UTXO en una transacción</p>
<p>Por ejemplo:</p>
<ul>
<li>La condición (única) de gasto de una wallet single-sig es la firma del dueño de dicha wallet.</li>
<li>La condición (uńica) de gasto de una wallet musltisg 2 de 2, es la firma de las dos llaves involucradas.</li>
<li>Una (de dos en total) condición de gasto de una wallet multisig 1 de 2, es la firma de una de las llaves involucradas</li>
</ul>
<p>Mientras que algunos de los puntos, como el de seguridad, pueden (y muchas veces son) minimizados por restricciones a nivel de policy, Miniscript soluciona un problema más general:</p>
<div style="text-align: center; font-style:italic ;">
dado un Bitcoin Script, ¿Es posible, por medio de un análisis simple, determinar todas las posibles condiciones de gasto?
</div>
<p>La respuesta es, para la mayoría de nosotros: No.</p>
<p>Para convencernos, veamos el siguiente ejemplo:</p>
<p>Miniscript Policy <strong>(A)</strong>:</p>
<div style="text-align: center;">
and(pk(Alice),or(pk(Bob),or(9@pk(Charlie),after(1710526010))))
</div>
<p>Bitcoin Script <strong>(B)</strong>:</p>
<div style="text-align: center;">
  <img src="articles/Script.jpeg" width=400/>
</div>
<p>Invitamos al lector a analizar por un momento la expresión <strong>(A)</strong>.</p>
<p>Asumiendo que una condición es de gasto, en el contexto de Miniscript, si toda la expresión, evaluada lógicamente, toma el valor de verdadero, debe resultar fácil convencerse de que las condiciones de gasto son:</p>
<ul>
<li>Firma de Alice y Firma Bob</li>
<li>Firma de Alice y Firma Charlie</li>
<li>Firma de Alice y el tiempo especificado (1710526010 unix time) ha transcurrido.</li>
</ul>
<p>Si las condiciones de gasto que mencionamos son ciertas, se sigue que:</p>
<ul>
<li>
<p>Los operadores <em>and</em> y <em>or</em> tienen un comportamiento similar al de sus homónimos lógicos (en caso de duda consulte las tablas de verdad para conjunciones y disyunciones)</p>
</li>
<li>
<p>Cada uno de sus elementos debe poder ser evaluado a un booleano (verdadero o falso)</p>
</li>
</ul>
<p>Sería incorrecto afirmar que las expresiones <strong>(A)</strong> Y <strong>(B)</strong> son equivalentes (recordemos nuestra breve digresión sobre subconjuntos), pero las <em>condiciones de gasto</em> expresadas en miniscript se conservan al pasar (con la ayuda de un compilador) de <strong>(A)</strong> a <strong>(B)</strong>.</p>
<h2 id="dos-miniscripts"><a class="header" href="#dos-miniscripts">¿Dos Miniscripts?</a></h2>
<p>Probablemente el lector habrá notado que en la sección anterior nos hemos referido a la expresión <strong>(A)</strong> como <strong>Miniscript Policy</strong> y no como <strong>Miniscript</strong>.</p>
<p>La razón es que son dos lenguajes diferentes.</p>
<p>La siguiente expresión <strong>(C):</strong></p>
<div style="text-align: center;">
and_v(or_c(pk(Bob),or_c(pk(Charlie),v:after(1710526010))),pk(Alice))
</div>
<p>Es el Miniscript que el Miniscript Policy <strong>(A)</strong> genera.</p>
<p>Examinemos de nuevo <strong>(A)</strong>:</p>
<div style="text-align: center;">
and(pk(Alice),or(pk(Bob),or(9@pk(Charlie),after(1710526010))))
</div>
<p>Notemos que las expresiones son muy similares, solo se eliminan algunas cosas de <strong>(A),</strong> como ese extraño ‘9@’ (del que hablaremos en la siguiente sección), se agregan otras como el  ‘v:’ y a los ‘and’ y ‘or’ se les agrega un par de caracteres (en realidad son tipos y modificadores).</p>
<p>Mientras que no entraremos a detalles sobre lo que significa cada uno de los cambios que ocurren cuando se pasa de <strong>(A)</strong> a <strong>(C)</strong>, vale la pena mencionar cómo ocurre esta transformación:</p>
<p>El Miniscript <strong>(C)</strong> se obtiene al compilar el Miniscript Policy <strong>(A)</strong></p>
<p>Naturalmente, el lector puede pensar que la razón de existir estos dos lenguajes es solo para evitarnos el trabajo de agregar todos esos caracteres (aparentemente necesarios) que aparecen en <strong>(A)</strong>, la razón resulta ser más fundamental:</p>
<div style="text-align: center;">
Existen diferentes formas (Bitcoin Scripts) de representar una misma condición de gasto.
</div>
<p>Para ilustrar el problema, consideremos una condición de gasto simple:</p>
<div style="text-align: center;">
pk(A)
</div>
<p>Podemos decir que existen al menos cuatro formas (opcodes) de comprobar esta condición:</p>
<ol>
<li>OP_CHECKSIG</li>
<li>OP_CHECKSIGVERIFY</li>
<li>OP_CHECKMULTISIG</li>
<li>OP_CHECKMULTISIGVERIFY</li>
</ol>
<p>En realidad basta con darnos cuenta que existen muchas formas de combinar los operadores 'and' y 'or' para expresar una condición dada.</p>
<p>Si hay varias opciones disponibles, tenemos la libertad de elegir ciertos parámetros de intéres para facilitar la elección, uno de ellos, del que hablaremos a continuación es:</p>
<div style="text-align: center;">
Optimización
</div>
<h2 id="probabilidades-y-optimización"><a class="header" href="#probabilidades-y-optimización">Probabilidades y Optimización</a></h2>
<p>Anteriormente mencionamos que para determinar las condiciones de gasto es útil pensar en que todos los elementos dentro de los operadores and y or deben poder ser evaluados a un booleano. Si asumimos que pk(A) es verdadero cuando se cuenta con una firma válida de A y falso cuando no, surge la pregunta:</p>
<p>¿Qué significa ‘N@pk(A)’ donde N es un número entero?</p>
<p>Empezaremos aclarando que ‘N@’ <strong>NO</strong> es un operador sobre el booleano pk(A):</p>
<p>N@pk(A) es verdadero si pk(A) es verdadero y falso si pk(A) es falso, sin importar el valor de N.</p>
<p>‘N@pk(A)’ es la notación para asignar a pk(A) una probabilidad relativa respecto a las otras condiciones que aparecen dentro de un mismo ‘or’.</p>
<p>Por lo tanto en la expresión <strong>(A),</strong> la presencia de ‘9@pk(Charlie)’ es para comunicarle al compilador, que la condición ‘pk(Charlie)’ es 9 veces más probable que la condición ‘after(1710526010)’.</p>
<p>Pero, ¿de qué sirve asignar probabilidades?</p>
<p>Como mencionamos en la sección anterior, dado un conjunto de posibles elecciones, nos conviene escoger aquella que, entre otras cosas, sea óptima.</p>
<p>Decimos que una elección es óptima si, al incluirla, el tamaño del Script resultante es el menor.</p>
<p>Al asignar probabilidades podemos comunicarle al compilador que una rama es más probable (o no) que las otras, en otras palabras, le decimos que le dé prioridad a optimizar ( reducir el tamaño) de la rama que es más probable, a costa de posiblemente incrementar el de la menor probabilidad.</p>
<h2 id="conclusión"><a class="header" href="#conclusión">Conclusión</a></h2>
<p>En este artículo hemos hablado un poco sobre la motivación para usar miniscript, así como de algunas de sus ideas principales, invitamos al lector a leer la documentación oficial si le interesa una introducción con mayor detalle.</p>
<p>En siguientes publicaciones hablaremos sobre Taproot y cómo se puede usar en conjunto con Miniscript.</p>
<p>Autor:</p>
<p><span style="font-weight: bold; color: blue;">Armando Medina</span></p>
<div style="break-before: page; page-break-before: always;"></div><div align="center">
  <img src="articles/../SV-Logo-Vertical-Black.svg" width=400/>
</div>
<h1 id="introduction-to-miniscript"><a class="header" href="#introduction-to-miniscript">Introduction to Miniscript</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>In this article, we will discuss Miniscript, aiming to cover the main ideas, which we believe are of interest to anyone looking to start using this powerful tool.</p>
<p>The best way to get introduced to a new technology is, as we know, by reading its documentation. The most comprehensive documentation can be found at: <a href="https://bitcoin.sipa.be/miniscript/">https://bitcoin.sipa.be/miniscript/</a>, written by Pieter Wuille, one of the creators of Miniscript. There, we find the definition that we will use in this article:</p>
<div style="text-align: center; font-style:italic ;">
“Miniscript is a language for writing (a subset of) Bitcoin Scripts in a structured way, enabling analysis, composition, generic signing and more”
</div>
<p>Therefore, according to the definition, Miniscript is:</p>
<div style="text-align: center; font-style:italic ;">
A language for writing a subset of Bitcoin Scripts.
</div>
<p>First, we will begin by discussing some of the concepts that appear in the definition.</p>
<h2 id="bitcoin-script-1"><a class="header" href="#bitcoin-script-1">Bitcoin Script</a></h2>
<p>If a currency is to be of any use, it is necessary for it to be transferable.</p>
<p>Therefore, it is necessary to define a mechanism that allows such transfer. Additionally, such a mechanism must be able to ensure the fulfillment of certain conditions, for example, that the person transferring the currency has the right to do so.</p>
<p>In the case of Bitcoin, the language that allows defining (and checking) these conditions is known as Bitcoin Script.</p>
<p>Bitcoin Script is a relatively simple programming language but, as we will see, can be difficult to use in practice.</p>
<p>In the following sections, whenever we use the word script, we will be referring to a Bitcoin Script.</p>
<h2 id="structure"><a class="header" href="#structure">Structure</a></h2>
<p>Every language implies structure, and the structure of Miniscript, as the definition tells us, enables among other things:</p>
<ol>
<li>Analysis</li>
<li>Composition</li>
</ol>
<h2 id="analysis"><a class="header" href="#analysis">Analysis</a></h2>
<p>Analysis is the act of examining something in detail, in this case, a script.</p>
<p>Some of the analyses that Miniscript facilitates are:</p>
<ul>
<li>Analysis of spending conditions: What are the spending conditions of a script?</li>
<li>Security analysis: Is it possible for a script to be malleable?</li>
<li>Cost analysis: What will be the cost of using a script?</li>
</ul>
<h2 id="composition"><a class="header" href="#composition">Composition</a></h2>
<p>Composition is the act of joining two or more things to form a new one.</p>
<p>In the case of Miniscript, composition refers to the ability to join two or more fragments (scripts) to form a new one.</p>
<h2 id="subset"><a class="header" href="#subset">Subset</a></h2>
<p>For better or worse, the word subset brings with it an intuitive connotation, and like all intuition, it is not always correct. One example will suffice:</p>
<div style="text-align: center; font-style:italic ;">
Drinking water is a subset of liquids.
</div>
<p>While it is true that the set of liquids has much more to offer than just water, it's easy to see why, in our daily lives, we are only interested in a particular subset.</p>
<p>The same is true in the case of Miniscript: the selected subset is such that it allows us to work with Bitcoin Script without having to worry too much about some of its complexities.</p>
<p>Although the above comment may seem trivial, it actually encapsulates the main motivation for using Miniscript:</p>
<div style="text-align: center; font-style:italic ;">
Using Bitcoin Script is hard.
</div>
<p>In particular, with Bitcoin Script, it is difficult to perform the analyses mentioned in the previous section, namely:</p>
<ul>
<li>Determine if a script is correct.</li>
<li>Determine if a script is safe (not prone to being malleable).</li>
<li>Estimate fees (the size of a transaction in the worst case).</li>
</ul>
<p>Before we continue our discussion, it is useful to introduce the following definition:</p>
<p><strong>Spending condition</strong>: is the set of minimum conditions that, when met, allow a UTXO to be successfully used in a transaction.</p>
<p>For example:</p>
<ul>
<li>The (single) spending condition of a single-sig wallet is the owner's signature.</li>
<li>The (single) spending condition of a 2 of 2 multisig wallet is the signature of the two keys involved.</li>
<li>One (of two total) spending condition of a 1 of 2 multisig wallet is the signature of one of the keys involved.</li>
</ul>
<p>While some points, like security, can (and often are) minimized by policy-level restrictions, Miniscript also solves another problem:</p>
<div style="text-align: center; font-style:italic ;">
given a Bitcoin Script, is it possible, through simple analysis, to determine all possible spending conditions?
</div>
<p>The answer is, for most of us: No.</p>
<p>To convince ourselves, let's look at the following example:</p>
<p>Miniscript Policy <strong>(A)</strong>:</p>
<div style="text-align: center;">
and(pk(Alice),or(pk(Bob),or(9@pk(Charlie),after(1710526010))))
</div>
<p>Bitcoin Script <strong>(B)</strong>:</p>
<div style="text-align: center;">
  <img src="articles/Script.jpeg" width=400/>
</div>
<p>We invite the reader to analyze expression <strong>(A)</strong> for a moment.</p>
<p>Assuming that a condition is a spending condition, in the context of Miniscript, if the entire expression, when logically evaluated, becomes true, it should be easy to convince oneself that the spending conditions are:</p>
<ul>
<li>Alice's signature and Bob's signature</li>
<li>Alice's signature and Charlie's signature</li>
<li>Alice's signature and the specified time (1710526010 unix time) has elapsed.</li>
</ul>
<p>If the spending conditions mentioned above are true, it follows that:</p>
<ul>
<li>
<p>The and and or operators behave similarly to their logical counterparts (when in doubt, consult the truth tables for conjunctions and disjunctions).</p>
</li>
<li>
<p>Each of its elements must be able to be evaluated to a boolean (true or false).</p>
</li>
</ul>
<p>It would be incorrect to claim that expressions <strong>(A)</strong> and <strong>(B)</strong> are equivalent (remember our brief digression on subsets), but the spending conditions expressed in Miniscript are preserved when transitioning (with the help of a compiler) from <strong>(A)</strong> to <strong>(B)</strong>.</p>
<h2 id="two-miniscripts"><a class="header" href="#two-miniscripts">Two Miniscripts?</a></h2>
<p>The reader may have noticed that in the previous section we referred to expression <strong>(A)</strong> as Miniscript Policy and not as Miniscript.</p>
<p>The reason is that they are two different languages.</p>
<p>The following expression <strong>(C)</strong>:</p>
<div style="text-align: center;">
and_v(or_c(pk(Bob),or_c(pk(Charlie),v:after(1710526010))),pk(Alice))
</div>
<p>Is the Miniscript generated by the Miniscript Policy <strong>(A)</strong>.</p>
<p>Let's examine <strong>(A)</strong> again:</p>
<div style="text-align: center;">
and(pk(Alice),or(pk(Bob),or(9@pk(Charlie),after(1710526010))))
</div>
<p>Notice that the expressions are very similar, only some things are removed from <strong>(A)</strong>, like that strange ‘9@’ (which we will talk about in the next section), others are added like the ‘v:’, and to the ‘and’ and ‘or’ a couple of characters are added (in reality, these are types and modifiers).</p>
<p>While we will not go into details about what each of the changes that occur when going from <strong>(A)</strong> to <strong>(C)</strong> means, it is worth mentioning how this transformation occurs:</p>
<p>The Miniscript <strong>(C)</strong> is obtained by compiling the Miniscript Policy <strong>(A)</strong>.</p>
<p>Naturally, the reader might think that the reason for these two languages to exist is only to save us the work of adding all those characters (apparently necessary) that appear in <strong>(A)</strong>, but the reason turns out to be more fundamental:</p>
<div style="text-align: center;">
There are different ways (Bitcoin Scripts) to represent the same spending condition.
</div>
<p>To illustrate the problem, let's take a simple spending condition.</p>
<div style="text-align: center;">
pk(A)
</div>
<p>pk(A) is true if there is a valid signature from A and false otherwise.</p>
<p>In principle there are at least four ways (opcodes) to check this condition:</p>
<ol>
<li>OP_CHECKSIG</li>
<li>OP_CHECKSIGVERIFY</li>
<li>OP_CHECKMULTISIG</li>
<li>OP_CHECKMULTISIGVERIFY</li>
</ol>
<p>In fact, it is enough to realize that there are many ways to combine the 'and' and 'or' operators to express a given condition.</p>
<p>If there are several options available, we have the freedom to choose certain parameters of interest to facilitate the choice, one of them, which we will discuss next, is:</p>
<div style="text-align: center;">
Optimization
</div>
<h2 id="probabilities-and-optimization"><a class="header" href="#probabilities-and-optimization">Probabilities and Optimization</a></h2>
<p>Previously we mentioned that to determine the spending conditions it is useful to think that all the elements within the 'and' and 'or' operators must be able to be evaluated to a boolean. If we assume that pk(A) is true when there is a valid signature from A and false otherwise, the question arises:</p>
<p>What does ‘N@pk(A)’ mean where N is an integer?</p>
<p>Let's start by clarifying that ‘N@’ is NOT an operator on the boolean pk(A):</p>
<p>N@pk(A) is true if pk(A) is true and false if pk(A) is false, regardless of the value of N.</p>
<p>‘N@pk(A)’ is the notation for assigning pk(A) a relative probability compared to the other conditions that appear within the same ‘or’.</p>
<p>Therefore, in expression <strong>(A)</strong>, the presence of ‘9@pk(Charlie)’ is to communicate to the compiler that the condition ‘pk(Charlie)’ is 9 times more likely than the condition 'after(1710526010)'.</p>
<p>But, what is the purpose of assigning probabilities?</p>
<p>As mentioned in the previous section, given a set of possible choices, it is to our advantage to choose the one that, among other things, is optimal.</p>
<p>We say a choice is optimal if, by including it, the resulting script's size is the smallest.</p>
<p>By assigning probabilities, we can communicate to the compiler that one branch is more likely (or not) than the others; in other words, we tell it to prioritize optimizing (reducing the size) of the more likely branch, at the expense of possibly increasing the size of the less probable one.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>In this article, we have talked a bit about the motivation to use Miniscript, as well as some of its main ideas. We invite the reader to read the official documentation if interested in a more in depth discussion.</p>
<p>In subsequent publications, we will discuss Taproot and how it can be used in conjunction with Miniscript.</p>
<p>Author:</p>
<p><span style="font-weight: bold; color: blue;">Armando Medina</span></p>
<div align="center">
  <img src="articles/../SV-Logo-Vertical-Black.svg" width=400/>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="tabs.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
